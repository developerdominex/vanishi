<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat - Starlight</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<style>
  .fade-enter { opacity: 0; transform: translateY(10px); }
  .fade-enter-active { opacity: 1; transform: translateY(0); transition: all 0.3s; }
  .message-container { display: flex; flex-direction: column; gap: 4px; }
  #call-dialog { position: fixed; inset:0; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:50; display:none; }
  #call-dialog .call-box { background:white; p-4 rounded shadow flex flex-col items-center space-y-4 w-80 text-center }
</style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

<header class="bg-white p-4 flex justify-between items-center shadow">
  <div class="flex items-center space-x-3">
    <button id="back-btn" class="p-2 rounded-full hover:bg-gray-200">
      <i data-feather="arrow-left"></i>
    </button>
    <img id="chat-profile" src="" class="w-10 h-10 rounded-full">
    <div>
      <div id="chat-name" class="font-semibold text-lg"></div>
      <div id="chat-status" class="text-sm text-gray-500">Offline</div>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <button id="video-call-btn" class="p-2 rounded-full hover:bg-gray-200">
      <i data-feather="video"></i>
    </button>
    <button id="voice-call-btn" class="p-2 rounded-full hover:bg-gray-200">
      <i data-feather="phone"></i>
    </button>
  </div>
</header>

<div id="messages" class="flex-1 overflow-y-auto p-4 message-container"></div>

<div class="bg-white p-2 flex items-center space-x-2 shadow">
  <input id="message-input" type="text" placeholder="Type a message"
         class="flex-1 p-2 border rounded focus:outline-none">
  <button id="send-btn" class="p-2 rounded-full bg-blue-500 text-white hidden">
    <i data-feather="send"></i>
  </button>
</div>

<div id="call-dialog">
  <div class="call-box space-y-4">
    <div id="call-text" class="text-lg font-semibold"></div>
    <div class="flex space-x-4">
      <button id="accept-call" class="p-2 rounded-full bg-green-500 text-white">Accept</button>
      <button id="decline-call" class="p-2 rounded-full bg-red-500 text-white">Decline</button>
      <button id="cancel-call" class="p-2 rounded-full bg-red-500 text-white hidden">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const MESSAGES_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const MESSAGES_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k";
const messagesSupabase = createClient(MESSAGES_URL, MESSAGES_KEY);

let hc_profile = JSON.parse(localStorage.getItem('hc_profile') || '{}');
const urlParams = new URLSearchParams(window.location.search);
const chatUser = {
  name: urlParams.get('name'),
  email: urlParams.get('email'),
  profile_url: urlParams.get('profile_url')
};

feather.replace();

document.getElementById('chat-name').innerText = chatUser.name;
document.getElementById('chat-profile').src = chatUser.profile_url;
document.getElementById('back-btn').addEventListener('click', () => window.location.href = 'home.html');

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const statusDiv = document.getElementById('chat-status');

input.addEventListener('input', () => {
  sendBtn.classList.toggle('hidden', input.value.trim() === '');
  sendTypingStatus();
});

sendBtn.addEventListener('click', async () => {
  const text = input.value.trim();
  if (!text) return;
  await messagesSupabase.from('messages').insert([{
    sender: hc_profile.email,
    receiver: chatUser.email,
    message: text,
    created_at: new Date()
  }]);
  input.value = '';
  sendBtn.classList.add('hidden');
});

async function fetchMessages() {
  const { data, error } = await messagesSupabase
    .from('messages')
    .select('*')
    .or(`sender.eq.${hc_profile.email},receiver.eq.${hc_profile.email}`)
    .order('created_at', { ascending: true });

  if (error) { console.error(error); return; }
  renderMessages(data.filter(m => m.sender === chatUser.email || m.receiver === chatUser.email));
}

function renderMessages(msgs) {
  messagesDiv.innerHTML = '';
  msgs.forEach(msg => {
    const div = document.createElement('div');
    div.className = 'p-2 rounded max-w-xs break-words fade-enter';
    if (msg.sender === hc_profile.email) {
      div.classList.add('bg-blue-500 text-white self-end');
    } else {
      div.classList.add('bg-gray-200 self-start');
    }
    div.innerText = msg.message;
    messagesDiv.appendChild(div);
    setTimeout(() => div.classList.add('fade-enter-active'), 10);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

let typingTimeout;
function sendTypingStatus() {
  messagesSupabase.channel('typing-' + hc_profile.email + '-' + chatUser.email)
    .send({ type: 'broadcast', event: 'typing', payload: { typing: input.value.length > 0 } });
}

messagesSupabase.channel('realtime-' + [hc_profile.email, chatUser.email].sort().join('-'))
  .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
    fetchMessages();
  })
  .on('broadcast', { event: 'typing' }, payload => {
    if (payload.typing) statusDiv.innerText = 'Typing...';
    else statusDiv.innerText = 'Online';
    clearTimeout(typingTimeout);
    if (payload.typing) typingTimeout = setTimeout(() => { statusDiv.innerText = 'Online'; }, 2000);
  })
  .on('broadcast', { event: 'call-offer' }, async payload => {
    showCallDialog('incoming', payload.payload.callType, payload.payload.sdp);
  })
  .subscribe();

const peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

document.getElementById('video-call-btn').addEventListener('click', () => startCall('video'));
document.getElementById('voice-call-btn').addEventListener('click', () => startCall('audio'));

const callDialog = document.getElementById('call-dialog');
const callText = document.getElementById('call-text');
const acceptBtn = document.getElementById('accept-call');
const declineBtn = document.getElementById('decline-call');
const cancelBtn = document.getElementById('cancel-call');

async function startCall(type) {
  showCallDialog('outgoing', type);
  const stream = await navigator.mediaDevices.getUserMedia(type === 'video' ? { video:true,audio:true } : { audio:true });
  stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  messagesSupabase.channel('webrtc-' + [hc_profile.email, chatUser.email].sort().join('-'))
    .send({ type: 'broadcast', event: 'call-offer', payload: { sdp: offer, callType: type } });
}

function showCallDialog(mode, type='video', sdp=null) {
  callDialog.style.display = 'flex';
  if(mode==='outgoing') {
    callText.innerText = `Calling ${chatUser.name}...`;
    acceptBtn.style.display='none';
    declineBtn.style.display='none';
    cancelBtn.style.display='inline-block';
  } else {
    callText.innerText = `${chatUser.name} is calling...`;
    acceptBtn.style.display='inline-block';
    declineBtn.style.display='inline-block';
    cancelBtn.style.display='none';
    acceptBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia(type==='video'?{video:true,audio:true}:{audio:true});
      stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
      await peerConnection.setRemoteDescription(sdp ? new RTCSessionDescription(sdp) : null);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      messagesSupabase.channel('webrtc-' + [hc_profile.email, chatUser.email].sort().join('-'))
        .send({ type:'broadcast', event:'call-answer', payload:{ sdp: answer } });
      callDialog.style.display='none';
    };
    declineBtn.onclick = () => { callDialog.style.display='none'; };
  }
  cancelBtn.onclick = () => { callDialog.style.display='none'; };
}

peerConnection.ontrack = (event) => {
  const video = document.createElement('video');
  video.srcObject = event.streams[0];
  video.autoplay = true;
  video.playsInline = true;
  video.style.position='fixed';
  video.style.bottom='10px';
  video.style.right='10px';
  video.style.width='200px';
  document.body.appendChild(video);
};

fetchMessages();
</script>
</body>
</html>
