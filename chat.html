<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat â€” Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{
  --bg:#f6fbff;
  --card:#ffffff;
  --sent-start:#6d28d9;
  --sent-end:#4f46e5;
  --received:#f8fafc;
  --received-border:#e6eefc;
  --accent:#2563eb;
  --muted:#6b7280;
  --radius:22px;
  --shadow: 0 6px 18px rgba(16,24,40,0.08);
  --small-shadow: 0 6px 14px rgba(79,70,229,0.12);
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
html,body{height:100%}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background: linear-gradient(180deg,#eaf6ff 0%, #f6fbff 60%);
  padding:28px;
}

/* container */
.container{
  width:420px;
  height:calc(100vh - 64px);
  max-height:960px;
  background:var(--card);
  border-radius:18px;
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  border:1px solid rgba(15,23,42,0.04);
}

/* header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 16px;
  backdrop-filter: blur(6px);
  background:linear-gradient(90deg, rgba(37,99,235,0.04), rgba(37,99,235,0.01));
  border-bottom: 1px solid rgba(15,23,42,0.03);
}
.left { display:flex; align-items:center; gap:12px; min-width:0; }
.back-btn{background:transparent;border:none;font-size:18px;padding:8px;border-radius:10px;cursor:pointer;color:var(--muted)}
.back-btn:hover{background:rgba(15,23,42,0.04)}
.avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;box-shadow:var(--small-shadow)}
.meta {display:flex;flex-direction:column; min-width:0}
.meta .name{font-weight:700;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .status{font-size:12px;color:var(--muted);margin-top:2px}
.header-actions {display:flex;align-items:center;gap:8px}
.icon-btn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;color:var(--muted);font-size:16px}
.icon-btn:hover{background:rgba(15,23,42,0.03)}
.icon-btn.disabled{opacity:0.38;pointer-events:none}

/* messages area */
.messages {
  flex:1;
  padding:18px 16px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:
    radial-gradient(800px 200px at 10% 10%, rgba(37,99,235,0.02), transparent 10%),
    linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  -webkit-overflow-scrolling: touch;
}

/* message row wrapper (keeps alignment clean) */
.message-row{
  display:flex;
  width:100%;
  align-items:flex-end;
  gap:10px;
  /* allow variable sizing for bubble */
}
.message-row.me{ justify-content:flex-end; }
.message-row.other{ justify-content:flex-start; }

/* bubble */
.bubble{
  max-width:78%;
  padding:10px 14px;
  border-radius:18px;
  word-break:break-word;
  position:relative;
  font-size:15px;
  line-height:1.35;
  transition: all 0.18s cubic-bezier(.2,.9,.2,1);
  box-shadow: 0 6px 18px rgba(16,24,40,0.04);
  opacity:0;
  transform: translateY(8px) scale(0.995);
  animation: bubble-pop 240ms ease forwards;
}

/* sent (me) */
.bubble.me{
  background: linear-gradient(135deg,var(--sent-start), var(--sent-end));
  color: #fff;
  border-radius: 18px 18px 6px 18px;
  box-shadow: 0 8px 20px rgba(79,70,229,0.12);
}

/* received */
.bubble.other{
  background: var(--received);
  color:#0b1220;
  border:1px solid var(--received-border);
  border-radius: 18px 18px 18px 6px;
}

/* timestamp small pill */
.ts{
  font-size:11px;
  color:rgba(11,17,34,0.55);
  position:absolute;
  bottom:-16px;
  right:10px;
  opacity:0.9;
  background:transparent;
}

/* small meta for received side (optionally show avatar) */
.msg-meta{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  min-width:36px;
}

/* composer */
.composer {
  padding:12px;
  display:flex;
  gap:10px;
  align-items:center;
  border-top:1px solid rgba(15,23,42,0.03);
  background: linear-gradient(180deg,#ffffff,#fbfdff);
}
.composer .left-actions { display:flex; gap:8px; align-items:center; }
.composer input{
  flex:1;padding:12px 14px;border-radius:20px;border:1px solid rgba(15,23,42,0.06);outline:none;font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff);
  box-shadow: inset 0 -1px 0 rgba(15,23,42,0.01);
}
.send-btn{width:46px;height:46px;border-radius:12px;border:none;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 22px rgba(37,99,235,0.12)}
.send-btn:active{transform:scale(0.98)}
.send-btn.hidden{display:none}

/* call dialog (unchanged visually but slightly polished) */
#call-dialog{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:1200}
.call-card{
  width:360px;
  background:var(--card);
  border-radius:18px;
  padding:20px;
  text-align:center;
  box-shadow:0 20px 60px rgba(2,6,23,0.35);
  display:flex;flex-direction:column;gap:12px
}
.call-peers{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.call-peer{display:flex;flex-direction:column;align-items:center;gap:6px}
.call-peer video, .call-peer img{width:120px;height:120px;border-radius:12px;object-fit:cover;background:#000}
.call-text{font-weight:700;margin-bottom:4px}
.call-sub{color:var(--muted);font-size:13px;margin-bottom:6px}
.call-actions{display:flex;gap:12px;justify-content:center}
.btn-accept{background:#16a34a;color:white;padding:10px 16px;border-radius:12px;border:none;cursor:pointer}
.btn-decline{background:#ef4444;color:white;padding:10px 16px;border-radius:12px;border:none}
.btn-cancel{background:#94a3b8;color:white;padding:10px 16px;border-radius:12px;border:none}

/* animations */
@keyframes bubble-pop{
  from{opacity:0; transform:translateY(8px) scale(0.995)}
  to{opacity:1; transform:translateY(0) scale(1)}
}

/* small screens */
@media (max-width:480px){
  .container{ width:100%; height:100vh; border-radius:0; }
  .avatar{width:40px;height:40px}
  .composer input{font-size:14px}
}
</style>
</head>
<body>

<div class="container" role="main" aria-label="Chat panel">
  <header>
    <div class="left">
      <button id="back-btn" class="back-btn" title="Back"><i class="fa-solid fa-arrow-left"></i></button>
      <img id="chat-profile" class="avatar" src="">
      <div class="meta">
        <div id="chat-name" class="name">Name</div>
        <div id="chat-status" class="status">Offline</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="video-call-btn" class="icon-btn" title="Start video call"><i class="fa-solid fa-video"></i></button>
      <button id="voice-call-btn" class="icon-btn" title="Start voice call"><i class="fa-solid fa-phone"></i></button>
    </div>
  </header>

  <div id="messages" class="messages" aria-live="polite" role="log"></div>

  <div class="composer" role="region" aria-label="Message composer">
    <div class="left-actions">
      <button class="icon-btn" title="Attach"><i class="fa-solid fa-plus"></i></button>
    </div>
    <input id="message-input" placeholder="Message..." aria-label="Message input">
    <button id="send-btn" class="send-btn hidden" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
  </div>
</div>

<div id="call-dialog" role="dialog" aria-modal="true">
  <div class="call-card">
    <div class="call-peers" id="call-peers"></div>
    <div class="call-text" id="call-peer-name">Calling...</div>
    <div class="call-sub" id="call-peer-sub">Connecting</div>
    <div class="call-actions">
      <button id="accept-call" class="btn-accept">Accept</button>
      <button id="decline-call" class="btn-decline">Decline</button>
      <button id="cancel-call" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k"; // your anon key
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const hc_profile = JSON.parse(localStorage.getItem('hc_profile')||'{}');
const params = new URLSearchParams(location.search);
const chatUser = {
  name: params.get('name'),
  email: params.get('email'),
  profile_url: params.get('profile_url') || `https://ui-avatars.com/api/?name=${encodeURIComponent(params.get('name'))}`
};

const backBtn = document.getElementById('back-btn');
const chatProfileEl = document.getElementById('chat-profile');
const chatNameEl = document.getElementById('chat-name');
const chatStatusEl = document.getElementById('chat-status');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const videoBtn = document.getElementById('video-call-btn');
const voiceBtn = document.getElementById('voice-call-btn');

const callDialog = document.getElementById('call-dialog');
const callPeers = document.getElementById('call-peers');
const callPeerName = document.getElementById('call-peer-name');
const callPeerSub = document.getElementById('call-peer-sub');
const acceptBtn = document.getElementById('accept-call');
const declineBtn = document.getElementById('decline-call');
const cancelBtn = document.getElementById('cancel-call');

backBtn.addEventListener('click', ()=>location.href='home.html');
chatNameEl.textContent = chatUser.name;
chatProfileEl.src = chatUser.profile_url;

// messages
let lastMessageTime=null;
async function loadMessages(){
  const { data } = await supabase.from('messages').select('*')
    .or(`and(sender.eq.${hc_profile.email},receiver.eq.${chatUser.email}),and(sender.eq.${chatUser.email},receiver.eq.${hc_profile.email})`)
    .order('created_at',{ascending:true})
    .gt('created_at', lastMessageTime || '1970-01-01T00:00:00Z');
  if(data.length>0){
    data.forEach(appendMessage);
    lastMessageTime = data[data.length-1].created_at;
  }
}
function appendMessage(m){
  // create a wrapper row so alignment is handled by CSS (align-self removed)
  const row = document.createElement('div');
  row.className = 'message-row ' + (m.sender===hc_profile.email ? 'me' : 'other');

  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (m.sender===hc_profile.email ? 'me' : 'other');
  bubble.textContent = m.message;

  const ts = document.createElement('div'); ts.className='ts';
  ts.textContent=new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  bubble.appendChild(ts);
  row.appendChild(bubble);
  messagesEl.appendChild(row);

  // scroll to bottom smoothly
  messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
}

// polling
setInterval(loadMessages, 1500);

// send message
sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('input', () => sendBtn.classList.toggle('hidden', inputEl.value.trim().length === 0));
inputEl.addEventListener('keydown', e => { if(e.key==='Enter') sendBtn.click(); });

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value=''; sendBtn.classList.add('hidden');
  await supabase.from('messages').insert([{ sender: hc_profile.email, receiver: chatUser.email, message: text, created_at: new Date().toISOString() }]);
}

// typing indicator
const typingChannel = 'typing-'+[hc_profile.email,chatUser.email].sort().join('-');
function sendTyping(flag){ supabase.channel(typingChannel).send({type:'broadcast',event:'typing',payload:{from:hc_profile.email,to:chatUser.email,typing:flag}});}
inputEl.addEventListener('input',()=>sendTyping(inputEl.value.trim().length>0));

supabase.channel(typingChannel).on('broadcast',{event:'typing'},({payload})=>{
  if(payload.from===chatUser.email && payload.to===hc_profile.email){
    chatStatusEl.textContent = payload.typing?'Typing...':'Online';
  }
}).subscribe();

// online/offline
const presenceChannel = 'presence-global';
supabase.channel(presenceChannel).on('broadcast',{event:'presence'},({payload})=>{
  if(payload.user===chatUser.email){
    chatStatusEl.textContent = payload.online?'Online':'Offline';
    videoBtn.classList.toggle('disabled',!payload.online);
    voiceBtn.classList.toggle('disabled',!payload.online);
  }
}).subscribe();

// WebRTC
let pc=null,localStream=null;
function ensurePeer(){
  if(pc) return pc;
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.onicecandidate=e=>{ if(e.candidate) sendSignal({type:'candidate',candidate:e.candidate});};
  pc.ontrack=e=>{
    const v = document.createElement('video'); v.autoplay=true; v.playsInline=true;
    v.srcObject=e.streams[0]; callPeers.appendChild(v);
  };
  return pc;
}
function sendSignal(payload){ supabase.channel('webrtc-'+[hc_profile.email,chatUser.email].sort().join('-')).send({type:'broadcast',event:'signal',payload:{from:hc_profile.email,to:chatUser.email,...payload}}); }
supabase.channel('webrtc-'+[hc_profile.email,chatUser.email].sort().join('-')).on('broadcast',{event:'signal'}, async ({payload})=>{
  if(!payload || payload.to!==hc_profile.email) return;
  if(payload.type==='call-offer') showCallDialog('incoming',payload.callType,payload.sdp);
  else if(payload.type==='call-answer') await ensurePeer().setRemoteDescription(new RTCSessionDescription(payload.sdp));
  else if(payload.type==='candidate') await ensurePeer().addIceCandidate(new RTCIceCandidate(payload.candidate));
}).subscribe();

function showCallDialog(mode='outgoing',callType='video',sdp=null){
  callDialog.style.display='flex'; callPeers.innerHTML='';
  if(mode==='outgoing'){
    callPeerName.textContent=`Calling ${chatUser.name}`; callPeerSub.textContent='Ringing...';
    acceptBtn.style.display='none'; declineBtn.style.display='none'; cancelBtn.style.display='inline-block';
  } else {
    callPeerName.textContent=chatUser.name; callPeerSub.textContent='Incoming call';
    acceptBtn.style.display='inline-block'; declineBtn.style.display='inline-block'; cancelBtn.style.display='none';
    acceptBtn.onclick=async ()=>{
      localStream=await navigator.mediaDevices.getUserMedia(callType==='video'?{video:true,audio:true}:{audio:true});
      localStream.getTracks().forEach(track=>ensurePeer().addTrack(track,localStream));
      await ensurePeer().setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await ensurePeer().createAnswer();
      await ensurePeer().setLocalDescription(answer);
      sendSignal({type:'call-answer',sdp:answer}); hideCallDialog();
    };
    declineBtn.onclick=()=>{ hideCallDialog(); sendSignal({type:'call-decline'}); };
  }
  cancelBtn.onclick=()=>{ hideCallDialog(); sendSignal({type:'call-cancel'});}
}
function hideCallDialog(){ callDialog.style.display='none'; callPeers.innerHTML='';}
async function startCall(callType='video'){
  if(chatStatusEl.textContent!=='Online') return;
  showCallDialog('outgoing',callType);
  localStream=await navigator.mediaDevices.getUserMedia(callType==='video'?{video:true,audio:true}:{audio:true});
  localStream.getTracks().forEach(track=>ensurePeer().addTrack(track,localStream));
  const offer=await ensurePeer().createOffer(); await ensurePeer().setLocalDescription(offer);
  sendSignal({type:'call-offer',callType,sdp:offer});
}
videoBtn.addEventListener('click',()=>startCall('video'));
voiceBtn.addEventListener('click',()=>startCall('audio'));

(async function init(){
  if(!hc_profile || !hc_profile.email){ alert('No profile'); location.href='register.html'; return; }
  await loadMessages();
})();
</script>
</body>
</html>
