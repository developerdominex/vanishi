<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat â€” Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --sent:#007aff;
  --received:#e4e6eb;
  --accent:#007aff;
  --muted:#8a8d91;
  --radius:18px;
  --shadow:0 4px 12px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
html,body{height:100%;}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background: var(--bg);
  padding:20px;
}
/* container */
.container{
  width:420px;
  height:calc(100vh - 40px);
  background:var(--card);
  border-radius:20px;
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
/* header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid rgba(0,0,0,0.05);
  background:#fff;
}
.left { display:flex; align-items:center; gap:12px; }
.back-btn{background:transparent;border:none;font-size:18px;padding:6px;border-radius:10px;cursor:pointer;color:var(--muted)}
.back-btn:hover{background:rgba(0,0,0,0.03)}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;}
.meta{display:flex;flex-direction:column;}
.meta .name{font-weight:600;color:#111; font-size:16px;}
.meta .status{font-size:12px;color:var(--muted); margin-top:2px;}
.header-actions{display:flex;gap:8px;}
.icon-btn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;color:var(--muted);font-size:16px;}
.icon-btn:hover{background:rgba(0,0,0,0.03);}
.icon-btn.disabled{opacity:0.4;pointer-events:none;}
.messages{
  flex:1;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
  background: #f0f2f5;
}
.composer{
  padding:12px 16px;
  display:flex;
  gap:10px;
  align-items:center;
  background:#fff;
  border-top:1px solid rgba(0,0,0,0.05);
}
.composer input{
  flex:1;
  padding:10px 14px;
  border-radius:20px;
  border:1px solid rgba(0,0,0,0.1);
  outline:none;
  font-size:15px;
  background:#f0f2f5;
}
.send-btn{
  width:44px;height:44px;border-radius:12px;border:none;
  background:var(--accent);color:white;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.send-btn:active{transform:scale(0.97);}
.send-btn.hidden{display:none;}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="left">
      <button id="back-btn" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
      <img id="chat-profile" class="avatar" src="">
      <div class="meta">
        <div id="chat-name" class="name">Name</div>
        <div id="chat-status" class="status">Offline</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="video-call-btn" class="icon-btn"><i class="fa-solid fa-video"></i></button>
      <button id="voice-call-btn" class="icon-btn"><i class="fa-solid fa-phone"></i></button>
    </div>
  </header>

  <div id="messages" class="messages" aria-live="polite" role="log"></div>

  <div class="composer">
    <input id="message-input" placeholder="Type a message">
    <button id="send-btn" class="send-btn hidden"><i class="fa-solid fa-paper-plane"></i></button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k"; // replace with your anon key
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const hc_profile = JSON.parse(localStorage.getItem('hc_profile')||'{}');
const params = new URLSearchParams(location.search);
const chatUser = {
  name: params.get('name'),
  email: params.get('email'),
  profile_url: params.get('profile_url') || `https://ui-avatars.com/api/?name=${encodeURIComponent(params.get('name'))}`
};

const backBtn = document.getElementById('back-btn');
const chatProfileEl = document.getElementById('chat-profile');
const chatNameEl = document.getElementById('chat-name');
const chatStatusEl = document.getElementById('chat-status');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const videoBtn = document.getElementById('video-call-btn');
const voiceBtn = document.getElementById('voice-call-btn');

backBtn.addEventListener('click', ()=>location.href='home.html');
chatNameEl.textContent = chatUser.name;
chatProfileEl.src = chatUser.profile_url;

function createMessageElement(message, sender){
  const row = document.createElement('div');
  row.style.display='flex';
  row.style.width='100%';
  row.style.margin='6px 0';
  row.style.justifyContent = sender===hc_profile.email?'flex-end':'flex-start';

  const bubble = document.createElement('div');
  bubble.textContent = message;
  Object.assign(bubble.style,{
    maxWidth:'70%',
    padding:'10px 14px',
    borderRadius:'18px',
    fontSize:'15px',
    lineHeight:1.4,
    position:'relative',
    boxShadow:'0 2px 8px rgba(0,0,0,0.1)',
    wordBreak:'break-word',
    opacity:0,
    transform:'translateY(10px)',
    color: sender===hc_profile.email?'#fff':'#111',
    backgroundColor: sender===hc_profile.email?'#007aff':'#e4e6eb',
    borderTopLeftRadius: sender===hc_profile.email?'18px':'6px',
    borderTopRightRadius: sender!==hc_profile.email?'18px':'6px',
    transition:'all 0.3s ease'
  });

  // timestamp
  const ts = document.createElement('div');
  ts.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  Object.assign(ts.style,{
    fontSize:'11px',
    color:'#8a8d91',
    marginTop:'4px',
    textAlign:'right'
  });

  // container for bubble + timestamp
  const bubbleContainer = document.createElement('div');
  bubbleContainer.style.display='flex';
  bubbleContainer.style.flexDirection='column';
  bubbleContainer.appendChild(bubble);
  bubbleContainer.appendChild(ts);

  row.appendChild(bubbleContainer);
  messagesEl.appendChild(row);

  // smooth pop animation
  requestAnimationFrame(()=>{ bubble.style.opacity=1; bubble.style.transform='translateY(0)'; });

  messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
}


// --- Load messages ---
let lastMessageTime=null;
async function loadMessages(){
  const { data } = await supabase.from('messages').select('*')
    .or(`and(sender.eq.${hc_profile.email},receiver.eq.${chatUser.email}),and(sender.eq.${chatUser.email},receiver.eq.${hc_profile.email})`)
    .order('created_at',{ascending:true})
    .gt('created_at', lastMessageTime || '1970-01-01T00:00:00Z');
  if(data.length>0){
    data.forEach(m=>createMessageElement(m.message,m.sender));
    lastMessageTime = data[data.length-1].created_at;
  }
}
setInterval(loadMessages,1500);

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('input',()=>sendBtn.classList.toggle('hidden', inputEl.value.trim().length===0));
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter')sendBtn.click();});

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value=''; sendBtn.classList.add('hidden');
  await supabase.from('messages').insert([{ sender: hc_profile.email, receiver: chatUser.email, message: text, created_at: new Date().toISOString() }]);
  createMessageElement(text,hc_profile.email);
}

// --- Typing ---
const typingChannel = 'typing-'+[hc_profile.email,chatUser.email].sort().join('-');
function sendTyping(flag){ supabase.channel(typingChannel).send({type:'broadcast',event:'typing',payload:{from:hc_profile.email,to:chatUser.email,typing:flag}});}
inputEl.addEventListener('input',()=>sendTyping(inputEl.value.trim().length>0));
supabase.channel(typingChannel).on('broadcast',{event:'typing'},({payload})=>{
  if(payload.from===chatUser.email && payload.to===hc_profile.email){
    chatStatusEl.textContent = payload.typing?'Typing...':'Online';
  }
}).subscribe();

// --- Presence ---
const presenceChannel = 'presence-global';
supabase.channel(presenceChannel).on('broadcast',{event:'presence'},({payload})=>{
  if(payload.user===chatUser.email){
    chatStatusEl.textContent = payload.online?'Online':'Offline';
    videoBtn.classList.toggle('disabled',!payload.online);
    voiceBtn.classList.toggle('disabled',!payload.online);
  }
}).subscribe();

// --- WebRTC Dynamic Call Modal ---
let pc=null, localStream=null;
function ensurePeer(){
  if(pc) return pc;
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.onicecandidate=e=>{ if(e.candidate) sendSignal({type:'candidate',candidate:e.candidate});};
  pc.ontrack=e=>{
    showCallModal('remote', e.streams[0]);
  };
  return pc;
}
function sendSignal(payload){ supabase.channel('webrtc-'+[hc_profile.email,chatUser.email].sort().join('-')).send({type:'broadcast',event:'signal',payload:{from:hc_profile.email,to:chatUser.email,...payload}});}
supabase.channel('webrtc-'+[hc_profile.email,chatUser.email].sort().join('-')).on('broadcast',{event:'signal'},async ({payload})=>{
  if(!payload || payload.to!==hc_profile.email) return;
  if(payload.type==='call-offer') showCallModal('incoming', payload.callType, payload.sdp);
  else if(payload.type==='call-answer') await ensurePeer().setRemoteDescription(new RTCSessionDescription(payload.sdp));
  else if(payload.type==='candidate') await ensurePeer().addIceCandidate(new RTCIceCandidate(payload.candidate));
}).subscribe();

// --- Call Modal --- same as before ---
function showCallModal(mode, callType='video', sdp=null, stream=null){
  const existing = document.querySelector('.call-modal'); if(existing) existing.remove();
  const modal = document.createElement('div'); modal.className='call-modal';
  Object.assign(modal.style,{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,0.5)',zIndex:1000});
  const card = document.createElement('div'); card.className='call-card';
  Object.assign(card.style,{background:'#fff',borderRadius:'16px',padding:'20px',width:'300px',display:'flex',flexDirection:'column',gap:'12px',textAlign:'center',boxShadow:'0 8px 24px rgba(0,0,0,0.2)'});
  const title = document.createElement('div'); title.style.fontWeight='600'; title.style.fontSize='16px'; title.style.marginBottom='4px';
  title.textContent=mode==='incoming'?'Incoming Call':`Calling ${chatUser.name}`;
  const sub = document.createElement('div'); sub.style.color='#6b7280'; sub.style.fontSize='13px';
  sub.textContent=mode==='incoming'?'Tap Accept to join':'Ringing...';
  card.appendChild(title); card.appendChild(sub);

  const btnContainer = document.createElement('div'); btnContainer.style.display='flex'; btnContainer.style.gap='10px'; btnContainer.style.justifyContent='center';

  if(mode==='incoming'){
    const accept=document.createElement('button'); accept.textContent='Accept';
    Object.assign(accept.style,{background:'#16a34a',color:'#fff',border:'none',padding:'10px 16px',borderRadius:'12px',cursor:'pointer'});
    accept.onclick=async ()=>{
      localStream=await navigator.mediaDevices.getUserMedia(callType==='video'?{video:true,audio:true}:{audio:true});
      localStream.getTracks().forEach(track=>ensurePeer().addTrack(track,localStream));
      await ensurePeer().setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await ensurePeer().createAnswer();
      await ensurePeer().setLocalDescription(answer);
      sendSignal({type:'call-answer',sdp:answer}); modal.remove();
    };
    const decline=document.createElement('button'); decline.textContent='Decline';
    Object.assign(decline.style,{background:'#ef4444',color:'#fff',border:'none',padding:'10px 16px',borderRadius:'12px',cursor:'pointer'});
    decline.onclick=()=>{ sendSignal({type:'call-decline'}); modal.remove(); };
    btnContainer.appendChild(accept); btnContainer.appendChild(decline);
  } else if(mode==='outgoing'){
    const cancel=document.createElement('button'); cancel.textContent='Cancel';
    Object.assign(cancel.style,{background:'#6b7280',color:'#fff',border:'none',padding:'10px 16px',borderRadius:'12px',cursor:'pointer'});
    cancel.onclick=()=>{ sendSignal({type:'call-cancel'}); modal.remove(); };
    btnContainer.appendChild(cancel);
  } else if(mode==='remote' && stream){
    const video=document.createElement('video'); video.autoplay=true; video.playsInline=true; video.srcObject=stream;
    Object.assign(video.style,{width:'240px',height:'180px',borderRadius:'12px',objectFit:'cover'});
    card.appendChild(video);
    const closeBtn=document.createElement('button'); closeBtn.textContent='End Call';
    Object.assign(closeBtn.style,{background:'#ef4444',color:'#fff',border:'none',padding:'10px 16px',borderRadius:'12px',cursor:'pointer'});
    closeBtn.onclick=()=>{ if(pc){ pc.close(); pc=null;} modal.remove();};
    btnContainer.appendChild(closeBtn);
  }

  card.appendChild(btnContainer);
  modal.appendChild(card);
  document.body.appendChild(modal);
}

async function startCall(type='video'){
  if(chatStatusEl.textContent!=='Online') return;
  showCallModal('outgoing', type);
  localStream=await navigator.mediaDevices.getUserMedia(type==='video'?{video:true,audio:true}:{audio:true});
  localStream.getTracks().forEach(track=>ensurePeer().addTrack(track,localStream));
  const offer = await ensurePeer().createOffer();
  await ensurePeer().setLocalDescription(offer);
  sendSignal({type:'call-offer', callType:type, sdp:offer});
}

videoBtn.addEventListener('click',()=>startCall('video'));
voiceBtn.addEventListener('click',()=>startCall('audio'));

(async function init(){
  if(!hc_profile || !hc_profile.email){ alert('No profile'); location.href='register.html'; return; }
  await loadMessages();
})();
</script>
</body>
</html>
