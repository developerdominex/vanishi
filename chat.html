<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat â€” Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --sent:#007aff;
  --received:#e4e6eb;
  --accent:#007aff;
  --muted:#8a8d91;
  --radius:18px;
  --shadow:0 4px 12px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
html,body{height:100%;}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background: var(--bg);
  padding:20px;
}
/* container */
.container{
  width:420px;
  height:calc(100vh - 40px);
  background:var(--card);
  border-radius:20px;
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
/* header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid rgba(0,0,0,0.05);
  background:#fff;
}
.left { display:flex; align-items:center; gap:12px; }
.back-btn{background:transparent;border:none;font-size:18px;padding:6px;border-radius:10px;cursor:pointer;color:var(--muted)}
.back-btn:hover{background:rgba(0,0,0,0.03)}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;}
.meta{display:flex;flex-direction:column;}
.meta .name{font-weight:600;color:#111; font-size:16px;}
.meta .status{font-size:12px;color:var(--muted); margin-top:2px;}
.header-actions{display:flex;gap:8px;}
.icon-btn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;color:var(--muted);font-size:16px;}
.icon-btn:hover{background:rgba(0,0,0,0.03);}
.icon-btn.disabled{opacity:0.4;pointer-events:none;}
.messages{
  flex:1;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
  background: #f0f2f5;
}
.composer{
  padding:12px 16px;
  display:flex;
  gap:10px;
  align-items:center;
  background:#fff;
  border-top:1px solid rgba(0,0,0,0.05);
}
.composer input{
  flex:1;
  padding:10px 14px;
  border-radius:20px;
  border:1px solid rgba(0,0,0,0.1);
  outline:none;
  font-size:15px;
  background:#f0f2f5;
}
.send-btn{
  width:44px;height:44px;border-radius:12px;border:none;
  background:var(--accent);color:white;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.send-btn:active{transform:scale(0.97);}
.send-btn.hidden{display:none;}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="left">
      <button id="back-btn" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
      <img id="chat-profile" class="avatar" src="">
      <div class="meta">
        <div id="chat-name" class="name">Name</div>
        <div id="chat-status" class="status">Offline</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="video-call-btn" class="icon-btn"><i class="fa-solid fa-video"></i></button>
      <button id="voice-call-btn" class="icon-btn"><i class="fa-solid fa-phone"></i></button>
    </div>
  </header>

  <div id="messages" class="messages" aria-live="polite" role="log"></div>

  <div class="composer">
    <input id="message-input" placeholder="Type a message">
    <button id="send-btn" class="send-btn hidden"><i class="fa-solid fa-paper-plane"></i></button>
  </div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const hc_profile = JSON.parse(localStorage.getItem('hc_profile')||'{}');
const params = new URLSearchParams(location.search);
const chatUser = {
  name: params.get('name'),
  email: params.get('email'),
  profile_url: params.get('profile_url') || `https://ui-avatars.com/api/?name=${encodeURIComponent(params.get('name'))}`
};

// UI Elements
const backBtn = document.getElementById('back-btn');
const chatProfileEl = document.getElementById('chat-profile');
const chatNameEl = document.getElementById('chat-name');
const chatStatusEl = document.getElementById('chat-status');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const videoBtn = document.getElementById('video-call-btn');
const voiceBtn = document.getElementById('voice-call-btn');

chatNameEl.textContent = chatUser.name;
chatProfileEl.src = chatUser.profile_url;
backBtn.onclick = () => location.href='home.html';

// -------------------- PRESENCE --------------------
async function updatePresence(online=true){
  supabase.channel('presence-global').send({type:'broadcast',event:'presence',payload:{user:hc_profile.email,online}});
}
updatePresence(true); // mark self online
window.addEventListener('beforeunload',()=>updatePresence(false)); // offline when leaving

supabase.channel('presence-global').on('broadcast',{event:'presence'},({payload})=>{
  if(payload.user===chatUser.email){
    chatStatusEl.textContent = payload.online?'Online':'Offline';
    videoBtn.disabled = !payload.online;
    voiceBtn.disabled = !payload.online;
  }
}).subscribe();

// -------------------- MESSAGES --------------------
let lastMessageTime = null;
const renderedIds = new Set();

function createMessageElement(message, sender, id=null){
  if(id && renderedIds.has(id)) return;
  if(id) renderedIds.add(id);

  const row = document.createElement('div');
  Object.assign(row.style,{
    display:'flex', width:'100%', margin:'6px 0',
    justifyContent: sender===hc_profile.email?'flex-end':'flex-start'
  });

  const bubbleContainer = document.createElement('div');
  Object.assign(bubbleContainer.style,{display:'flex', flexDirection:'column', alignItems: sender===hc_profile.email?'flex-end':'flex-start', maxWidth:'70%'});

  const bubble = document.createElement('div');
  bubble.textContent = message;
  Object.assign(bubble.style,{
    padding:'10px 14px', borderRadius:'18px', fontSize:'15px', lineHeight:1.4,
    boxShadow:'0 2px 8px rgba(0,0,0,0.1)', wordBreak:'break-word',
    opacity:0, transform:'translateY(10px)',
    color: sender===hc_profile.email?'#fff':'#111',
    backgroundColor: sender===hc_profile.email?'#007aff':'#e4e6eb',
    borderTopLeftRadius: sender===hc_profile.email?'18px':'6px',
    borderTopRightRadius: sender!==hc_profile.email?'18px':'6px',
    borderBottomLeftRadius:'18px', borderBottomRightRadius:'18px',
    transition:'all 0.3s ease'
  });

  const ts = document.createElement('div');
  ts.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  Object.assign(ts.style,{fontSize:'11px',color:'#8a8d91',marginTop:'4px'});

  bubbleContainer.append(bubble, ts);
  row.appendChild(bubbleContainer);
  messagesEl.appendChild(row);

  requestAnimationFrame(()=>{
    bubble.style.opacity=1;
    bubble.style.transform='translateY(0)';
  });

  messagesEl.scrollTo({top: messagesEl.scrollHeight, behavior:'smooth'});
}

async function loadMessages(){
  const { data } = await supabase.from('messages').select('*')
    .or(`and(sender.eq.${hc_profile.email},receiver.eq.${chatUser.email}),and(sender.eq.${chatUser.email},receiver.eq.${hc_profile.email})`)
    .order('created_at',{ascending:true})
    .gt('created_at', lastMessageTime||'1970-01-01T00:00:00Z');

  if(data.length){
    data.forEach(m=>createMessageElement(m.message,m.sender,m.id));
    lastMessageTime = data[data.length-1].created_at;
  }
}
setInterval(loadMessages,1000);

// -------------------- SEND MESSAGE --------------------
sendBtn.onclick = sendMessage;
inputEl.oninput = () => sendBtn.classList.toggle('hidden',inputEl.value.trim().length===0);
inputEl.onkeydown = e => { if(e.key==='Enter') sendBtn.click(); };

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value=''; sendBtn.classList.add('hidden');
  const { data } = await supabase.from('messages').insert([{sender:hc_profile.email,receiver:chatUser.email,message:text,created_at:new Date().toISOString()}]).select();
  if(data.length) createMessageElement(data[0].message, data[0].sender, data[0].id);
}

// -------------------- TYPING --------------------
const typingChannel = 'typing-'+[hc_profile.email,chatUser.email].sort().join('-');
function sendTyping(flag){ supabase.channel(typingChannel).send({type:'broadcast',event:'typing',payload:{from:hc_profile.email,to:chatUser.email,typing:flag}});}
inputEl.addEventListener('input',()=>sendTyping(inputEl.value.trim().length>0));

supabase.channel(typingChannel).on('broadcast',{event:'typing'},({payload})=>{
  if(payload.from===chatUser.email && payload.to===hc_profile.email){
    chatStatusEl.textContent = payload.typing?'Typing...':'Online';
  }
}).subscribe();
// -------------------- WEBRTC --------------------
let pc = null, localStream = null, remoteStream = null;
let audioCtx = null, analyser = null, source = null;
let inCall = false;

// Create PeerConnection
function ensurePeer() {
  if (pc) return pc;
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.ontrack = (event) => {
    if (!remoteStream) remoteStream = new MediaStream();
    remoteStream.addTrack(event.track);

    if (event.track.kind === 'video') showCallModal('connected-video', remoteStream);
    if (event.track.kind === 'audio') showCallModal('connected-audio', null, remoteStream);
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) sendSignal({ type: 'candidate', candidate: e.candidate });
  };

  return pc;
}

// Send signal to Supabase
function sendSignal(payload) {
  supabase.channel('webrtc-' + [hc_profile.email, chatUser.email].sort().join('-'))
    .send({ type: 'broadcast', event: 'signal', payload: { from: hc_profile.email, to: chatUser.email, ...payload } });
}

// Receive signal
supabase.channel('webrtc-' + [hc_profile.email, chatUser.email].sort().join('-'))
  .on('broadcast', { event: 'signal' }, async ({ payload }) => {
    if (!payload || payload.to !== hc_profile.email) return;

    if (payload.type === 'call-offer') showCallModal('incoming', payload.callType, payload.sdp);
    if (payload.type === 'call-answer') await ensurePeer().setRemoteDescription(new RTCSessionDescription(payload.sdp));
    if (payload.type === 'candidate') await ensurePeer().addIceCandidate(new RTCIceCandidate(payload.candidate));
    if (payload.type === 'call-end') endCallLocal();
  }).subscribe();

// -------------------- CALL UI & LOGIC --------------------
function showCallModal(mode, callType = 'video', sdp = null, remoteAudioStream = null) {
  // Clean old modal
  document.querySelectorAll('.call-modal').forEach(m => m.remove());

  const modal = document.createElement('div');
  modal.className = 'call-modal';
  Object.assign(modal.style, {
    position: 'fixed', inset: 0, display: 'flex', alignItems: 'center',
    justifyContent: 'center', background: 'rgba(0,0,0,0.5)', zIndex: 2000
  });

  const card = document.createElement('div');
  Object.assign(card.style, {
    background: '#fff', padding: '20px', width: '300px', borderRadius: '16px',
    display: 'flex', flexDirection: 'column', gap: '12px', textAlign: 'center'
  });

  const title = document.createElement('div');
  title.style.fontSize = '16px';
  title.style.fontWeight = '600';

  const subtitle = document.createElement('div');
  subtitle.style.fontSize = '13px';
  subtitle.style.color = '#666';

  const buttons = document.createElement('div');
  Object.assign(buttons.style, { display: 'flex', justifyContent: 'center', gap: '12px' });

  // ---------- Incoming ----------
  if (mode === 'incoming') {
    title.textContent = `Incoming ${callType} call`;
    subtitle.textContent = 'Accept or decline';

    const accept = document.createElement('button');
    accept.textContent = 'Accept';
    Object.assign(accept.style, btnGreen);
    accept.onclick = async () => {
      inCall = true;
      localStream = await navigator.mediaDevices.getUserMedia(callType === 'video' ? { video: true, audio: true } : { audio: true });
      localStream.getTracks().forEach(t => ensurePeer().addTrack(t, localStream));

      await ensurePeer().setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await ensurePeer().createAnswer();
      await ensurePeer().setLocalDescription(answer);
      sendSignal({ type: 'call-answer', sdp: answer });
      showLocalPreview(localStream, callType);
      if (callType === 'audio') startVoiceWave(localStream);
      modal.remove();
    };

    const decline = document.createElement('button');
    decline.textContent = 'Decline';
    Object.assign(decline.style, btnRed);
    decline.onclick = () => { sendSignal({ type: 'call-end' }); modal.remove(); };

    buttons.append(accept, decline);
  }

  // ---------- Outgoing ----------
  if (mode === 'outgoing') {
    title.textContent = `Calling ${chatUser.name}...`;
    subtitle.textContent = 'Ringing';

    const cancel = document.createElement('button');
    cancel.textContent = 'Cancel';
    Object.assign(cancel.style, btnGray);
    cancel.onclick = () => { sendSignal({ type: 'call-end' }); endCallLocal(); };

    buttons.append(cancel);
  }

  // ---------- Connected (Video) ----------
  if (mode === 'connected-video') {
    title.textContent = 'Video Call';
    subtitle.textContent = '';

    const video = document.createElement('video');
    video.srcObject = callType;
    video.autoplay = true;
    video.playsInline = true;
    Object.assign(video.style, { width: '260px', height: '200px', borderRadius: '12px', objectFit: 'cover' });

    card.append(video);

    const end = document.createElement('button');
    end.textContent = 'End Call';
    Object.assign(end.style, btnRed);
    end.onclick = () => endCall();

    buttons.append(end);
  }

  // ---------- Connected (Voice) ----------
  if (mode === 'connected-audio') {
    title.textContent = 'Voice Call';
    subtitle.textContent = `With ${chatUser.name}`;

    // Microphone icon + wave
    const mic = document.createElement('div');
    mic.innerHTML = 'ðŸŽ¤';
    Object.assign(mic.style, { fontSize: '40px', margin: '10px auto' });

    const wave = document.createElement('div');
    wave.className = 'voice-wave';
    Object.assign(wave.style, {
      width: '100px', height: '6px', margin: 'auto', borderRadius: '3px',
      background: 'linear-gradient(90deg,#4ade80,#22c55e)'
    });

    card.append(mic, wave);

    // Play remote voice
    playRemoteAudio(remoteAudioStream);

    const end = document.createElement('button');
    end.textContent = 'End Call';
    Object.assign(end.style, btnRed);
    end.onclick = () => endCall();

    buttons.append(end);
  }

  card.append(title, subtitle, buttons);
  modal.append(card);
  document.body.append(modal);
}

// -------------------- END CALL BOTH SIDES --------------------
function endCall() {
  sendSignal({ type: 'call-end' });
  endCallLocal();
}

function endCallLocal() {
  document.querySelectorAll('.call-modal').forEach(m => m.remove());
  removeLocalPreview();
  const audio = document.querySelector('.remote-audio'); if (audio) audio.remove();
  if (pc) pc.close();
  pc = null;
  inCall = false;
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  localStream = null;
  remoteStream = null;
}

// -------------------- UI HELPERS --------------------
const btnGreen = { background: '#16a34a', color: '#fff', padding: '10px 16px', border: 'none', borderRadius: '8px', cursor: 'pointer' };
const btnRed = { background: '#ef4444', color: '#fff', padding: '10px 16px', border: 'none', borderRadius: '8px', cursor: 'pointer' };
const btnGray = { background: '#6b7280', color: '#fff', padding: '10px 16px', border: 'none', borderRadius: '8px', cursor: 'pointer' };

// Show small preview bottom corner
function showLocalPreview(stream, type) {
  removeLocalPreview();
  if (type === 'video') {
    const video = document.createElement('video');
    video.srcObject = stream;
    video.autoplay = true;
    video.muted = true;
    Object.assign(video.style, {
      position: 'fixed', bottom: '20px', right: '20px', width: '120px',
      height: '100px', borderRadius: '12px', objectFit: 'cover', zIndex: 2000
    });
    video.className = 'local-preview';
    document.body.append(video);
  }
}

function removeLocalPreview() {
  const el = document.querySelector('.local-preview');
  if (el) el.remove();
}

// -------------------- AUDIO WAVE ANIMATION --------------------
function startVoiceWave(stream) {
  const wave = document.querySelector('.voice-wave');
  if (!wave) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  source = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);

  const data = new Uint8Array(analyser.frequencyBinCount);
  (function loop() {
    if (!inCall) return;
    analyser.getByteFrequencyData(data);
    let avg = data.reduce((a, b) => a + b, 0) / data.length;
    wave.style.transform = `scaleY(${Math.max(1, avg / 30)})`;
    requestAnimationFrame(loop);
  })();
}

// -------------------- START CALL --------------------
async function startCall(type = 'video') {
  showCallModal('outgoing', type);
  localStream = await navigator.mediaDevices.getUserMedia(type === 'video' ? { video: true, audio: true } : { audio: true });
  localStream.getTracks().forEach(t => ensurePeer().addTrack(t, localStream));
  const offer = await ensurePeer().createOffer();
  await ensurePeer().setLocalDescription(offer);
  sendSignal({ type: 'call-offer', callType: type, sdp: offer });
  showLocalPreview(localStream, type);
  if (type === 'audio') startVoiceWave(localStream);
}

// Attach to buttons
videoBtn.onclick = () => startCall('video');
voiceBtn.onclick = () => startCall('audio');

// -------------------- INIT --------------------
(async function init(){
  if(!hc_profile || !hc_profile.email){ alert('No profile'); location.href='register.html'; return; }
  await loadMessages();
})();
</script>

</body>
</html>
