<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Realtime Chat â€” Animated</title>
<link rel="icon" type="image/png" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg-dark: #0f172a;
  --bg-light: #1e293b;
  --accent: #3b82f6;
  --text-light: #f8fafc;
  --text-dim: #cbd5e1;
}

* {
  box-sizing: border-box;
  user-select: none;
}

body {
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Roboto, sans-serif;
  background: var(--bg-dark);
  color: var(--text-light);
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* --- TOP BAR --- */
header {
  background: var(--bg-light);
  color: var(--text-light);
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #334155;
}

header h2 {
  margin: 0;
  font-size: 18px;
  letter-spacing: 0.5px;
}

#menuToggle {
  font-size: 22px;
  cursor: pointer;
  color: var(--text-light);
}

/* --- LAYOUT --- */
.container {
  flex: 1;
  display: flex;
  height: 100%;
  overflow: hidden;
}

#userList {
  width: 300px;
  background: var(--bg-light);
  border-right: 1px solid #334155;
  display: flex;
  flex-direction: column;
  transition: transform 0.3s ease;
  z-index: 10;
}

#userList.active {
  transform: translateX(0);
}

@media (max-width: 768px) {
  #userList {
    position: fixed;
    height: 100%;
    left: 0;
    top: 0;
    transform: translateX(-100%);
  }
}

#searchInput {
  background: #0f172a;
  border: none;
  color: var(--text-light);
  padding: 12px;
  font-size: 14px;
  outline: none;
  width: 100%;
  border-bottom: 1px solid #334155;
}

#users {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.user-card {
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: background 0.2s;
  margin-bottom: 4px;
}

.user-card:hover {
  background: #334155;
}

.user-card.selected {
  background: var(--accent);
}

.user-thumb {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  margin-right: 10px;
}

.user-meta {
  flex: 1;
  color: var(--text-dim);
}

.user-meta strong {
  display: flex;
  justify-content: space-between;
  color: var(--text-light);
  font-size: 15px;
}

.timestamp {
  color: var(--text-dim);
  font-size: 12px;
}

.last-message {
  font-size: 13px;
  opacity: 0.8;
}

.unread strong {
  color: #facc15;
}

/* --- CHAT AREA --- */
#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-dark);
  transition: all 0.3s ease;
}

#chatContainer:not(.active) {
  display: none;
}

#chatHeader {
  background: var(--bg-light);
  padding: 10px 15px;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #334155;
}

#chatAvatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  margin-right: 10px;
  display: none;
}

#chatWith {
  font-weight: 600;
  font-size: 15px;
}

#chatStatus {
  font-size: 12px;
  color: var(--text-dim);
}

#closeBtn {
  margin-left: auto;
  cursor: pointer;
  font-size: 20px;
  color: var(--text-dim);
}

#chatBody {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  background: var(--bg-dark);
  display: flex;
  flex-direction: column;
}

.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 20px;
  margin: 5px 0;
  animation: fadeIn 0.3s ease;
  word-break: break-word;
}

.msg.me {
  background: var(--accent);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 5px;
}

.msg.received {
  background: #1e293b;
  color: var(--text-light);
  align-self: flex-start;
  border-bottom-left-radius: 5px;
}

.msg img {
  max-width: 200px;
  border-radius: 10px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- CHAT CONTROLS --- */
#chatControls {
  display: flex;
  align-items: center;
  background: var(--bg-light);
  padding: 8px;
  border-top: 1px solid #334155;
}

#chatInput {
  flex: 1;
  background: #0f172a;
  color: var(--text-light);
  border: none;
  outline: none;
  border-radius: 20px;
  padding: 10px 14px;
  font-size: 14px;
}

#chatFile {
  display: none;
}

button {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 20px;
  margin-left: 10px;
}

button:hover {
  color: #60a5fa;
}

::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-thumb {
  background: #475569;
  border-radius: 10px;
}
::-webkit-scrollbar-thumb:hover {
  background: #64748b;
}

/* Responsive Chat Layout */
@media (max-width: 768px) {
  header h2 {
    font-size: 16px;
  }
  #chatContainer.active {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 20;
  }
  #chatBody {
    padding: 10px;
  }
}
</style>
</head>
<body>


 <div class="container">
    <div id="userList">
      <input type="text" id="searchInput" placeholder="Search users..." />
      <div id="users"></div>
      <button id="logoutBtn" style="padding: 12px; margin: 8px; border-radius: 8px; background: #ef4444; color: white;">Logout</button>
    </div>

    <div id="chatContainer">
      <div id="chatHeader">
        <img id="chatAvatar" src="" alt="Avatar" />
        <div>
          <div id="chatWith">Select a user</div>
          <div id="chatStatus"></div>
        </div>
        <i id="closeBtn" class="fas fa-times"></i>
      </div>

      <div id="chatBody" class="placeholder">
        <p style="text-align:center;opacity:0.6;">Select a user to start chatting</p>
      </div>

      <div id="chatControls">
        <input id="chatInput" type="text" placeholder="Type a message..." />
        <input type="file" id="chatFile" accept="image/*" />
        <button id="attachBtn"><i class="fas fa-paperclip"></i></button>
        <button id="sendBtn" style="display:none;"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// Supabase setup
const supabaseUrl = 'https://dfzshvldanqfvfivjrqi.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA';
const supabase = createClient(supabaseUrl, supabaseKey);

// DOM elements
const usersDiv = document.getElementById('users');
const searchInput = document.getElementById('searchInput');
const chatWith = document.getElementById('chatWith');
const chatStatus = document.getElementById('chatStatus');
const chatAvatar = document.getElementById('chatAvatar');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatFile = document.getElementById('chatFile');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const chatContainer = document.getElementById('chatContainer');
const closeBtn = document.getElementById('closeBtn');

// Google Drive chat.json setup
const DRIVE_FILE_NAME = "chat.json"; // file in Drive
let DRIVE_FILE_ID = null;
let DRIVE_ACCESS_TOKEN = null;

// User profile
let profile = JSON.parse(localStorage.getItem('hc_profile') || 'null');
if(!profile){ window.location.href = 'register.html'; throw new Error('No profile'); }
DRIVE_ACCESS_TOKEN = profile.token;

let onlineUsers = {}, pcMap = {}, dataChannelMap = {}, chatHistory = {}, currentPeer = null, typingTimeout;

// --- Google Drive helpers ---
async function fetchChatJSON() {
  try {
    // List file ID
    const listRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}'`,{
      headers:{Authorization:`Bearer ${DRIVE_ACCESS_TOKEN}`}
    });
    const listData = await listRes.json();
    DRIVE_FILE_ID = listData.files?.[0]?.id || null;
    if(!DRIVE_FILE_ID) return; // file not found yet

    // Fetch content
    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${DRIVE_FILE_ID}?alt=media`,{
      headers:{Authorization:`Bearer ${DRIVE_ACCESS_TOKEN}`}
    });
    if(!res.ok) throw new Error('Cannot fetch chat.json');
    chatHistory = await res.json();
    localStorage.setItem('hc_chat', JSON.stringify(chatHistory));
  } catch(e){
    console.warn('Using localStorage fallback for chat', e);
    chatHistory = JSON.parse(localStorage.getItem('hc_chat') || '{}');
  }
}

async function updateChatJSON() {
  try {
    const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(chatHistory)], { type: 'application/json' }));

    const uploadUrl = DRIVE_FILE_ID
      ? `https://www.googleapis.com/upload/drive/v3/files/${DRIVE_FILE_ID}?uploadType=multipart`
      : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;

    const res = await fetch(uploadUrl, {
      method: DRIVE_FILE_ID ? 'PATCH' : 'POST',
      headers:{Authorization:`Bearer ${DRIVE_ACCESS_TOKEN}`},
      body: form
    });

    if(!res.ok) throw new Error('Failed updating chat.json');
    const data = await res.json();
    DRIVE_FILE_ID = data.id;
  } catch(e){ console.warn(e); }
}

// --- User list & chat rendering ---
searchInput.addEventListener('input', ()=>renderUsers(searchInput.value.trim()));

function renderUsers(filter='') {
  usersDiv.innerHTML = '';
  Object.values(onlineUsers)
    .filter(u=>u.uuid!==profile.id && (!filter||u.name.toLowerCase().includes(filter.toLowerCase())))
    .sort((a,b)=>{
      const aTime = chatHistory[a.uuid]?.[chatHistory[a.uuid].length-1]?.ts || 0;
      const bTime = chatHistory[b.uuid]?.[chatHistory[b.uuid].length-1]?.ts || 0;
      return bTime - aTime;
    })
    .forEach(u=>{
      const lastMsgObj = chatHistory[u.uuid]?.[chatHistory[u.uuid].length-1];
      const lastMsg = lastMsgObj ? lastMsgObj.text : 'No messages yet';
      const isUnread = lastMsgObj?.me===false && !lastMsgObj.read;

      const div = document.createElement('div'); div.className='user-card';
      div.innerHTML=`
        <div style="display:flex;align-items:center;width:100%;">
          <img class="user-thumb" src="${u.avatar}">
          <div class="user-meta ${isUnread?'unread':''}">
            <strong>${u.name} <span class="timestamp">${lastMsgObj ? formatTime(lastMsgObj.ts) : ''}</span></strong>
            <span class="last-message">${lastMsg}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', ()=>{
        if(chatHistory[u.uuid]) chatHistory[u.uuid].forEach(m=>m.read=true);
        openChat(u, div);
        renderUsers(searchInput.value.trim());
      });
      usersDiv.appendChild(div);
    });
}

function formatTime(ts){
  const d = new Date(ts);
  let h = d.getHours(), m=d.getMinutes().toString().padStart(2,'0'), ampm=h>=12?'PM':'AM';
  h = h%12||12;
  return `${h}:${m} ${ampm}`;
}

function openChat(user, element){
  document.querySelectorAll('.user-card').forEach(e=>e.classList.remove('selected'));
  element.classList.add('selected');
  currentPeer = user.uuid;
  chatWith.textContent = user.name;
  chatStatus.textContent = 'Online';
  chatAvatar.src = user.avatar;
  chatAvatar.style.display = 'block';
  chatBody.classList.remove('placeholder');
  chatBody.innerHTML = '';
  if(!chatHistory[currentPeer]) chatHistory[currentPeer] = [];
  chatHistory[currentPeer].forEach(msg=>appendMessage(currentPeer, msg.text, msg.me, msg.isImage, false));
  if(!pcMap[user.uuid]) createPeerConnection(user.uuid);
  chatContainer.classList.add('active');
}

function appendMessage(userUuid, text, me=false, isImage=false, save=true){
  const div = document.createElement('div'); div.className = 'msg '+(me?'me':'received');
  if(isImage){ const img = document.createElement('img'); img.src=text; div.appendChild(img);}
  else div.textContent = text;
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
  if(save){
    if(!chatHistory[userUuid]) chatHistory[userUuid]=[];
    chatHistory[userUuid].push({text, me, isImage, ts: Date.now(), read: me});
    localStorage.setItem('hc_chat', JSON.stringify(chatHistory));
    updateChatJSON();
    renderUsers(searchInput.value.trim());
  }
}

// --- Typing ---
chatInput.addEventListener('input', ()=>{
  if(currentPeer) sendSignal(currentPeer, {type:'typing'});
});
function showTyping(userUuid){
  if(currentPeer!==userUuid) return;
  chatStatus.textContent = 'Typing...';
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{chatStatus.textContent='Online'}, 1000);
}

// --- WebRTC & Supabase real-time ---
async function startRealtime(){
  await fetchChatJSON();

  const presence = supabase.channel('public:presence');
  presence.on('broadcast', {event:'user-presence'}, payload=>{
    const u = payload.payload;
    if(!u?.uuid) return;
    if(u.action==='join'||u.action==='update'){ onlineUsers[u.uuid] = {...u}; renderUsers(searchInput.value.trim());}
    else if(u.action==='leave'){ delete onlineUsers[u.uuid]; renderUsers(searchInput.value.trim());}
  });

  const signaling = supabase.channel('public:signaling');
  signaling.on('broadcast', {event:'signal'}, async payload=>{
    const msg = payload.payload;
    if(!msg||msg.to!==profile.id) return;
    if(msg.type==='offer') await handleOffer(msg.from, msg.sdp);
    else if(msg.type==='answer') await handleAnswer(msg.from, msg.sdp);
    else if(msg.type==='candidate') await handleCandidate(msg.from, msg.candidate);
    else if(msg.type==='message') appendMessage(msg.from, msg.data, false, msg.isImage);
    else if(msg.type==='typing') showTyping(msg.from);
  });

  await presence.subscribe(); await signaling.subscribe();
  broadcastPresence('join');
  setInterval(()=>broadcastPresence('update'), 25000);
  window.addEventListener('beforeunload', ()=>broadcastPresence('leave'));
}

async function broadcastPresence(action){
  await supabase.channel('public:presence').send({type:'broadcast', event:'user-presence', payload:{...profile, action, ts: Date.now()}});
}

function createPeerConnection(peer){
  const pc = new RTCPeerConnection();
  const dc = pc.createDataChannel('chat');
  dc.onmessage = e=>{ appendMessage(peer, e.data, false); updateChatJSON(); };
  dataChannelMap[peer] = dc;
  pc.onicecandidate = e=>{ if(e.candidate) sendSignal(peer, {type:'candidate', candidate: e.candidate}); };
  pc.ondatachannel = e=>{ e.channel.onmessage = e=>{ appendMessage(peer, e.data, false); updateChatJSON(); } };
  pcMap[peer] = pc;
  makeOffer(peer);
}

async function makeOffer(peer){ const pc = pcMap[peer]; const offer = await pc.createOffer(); await pc.setLocalDescription(offer); sendSignal(peer, {type:'offer', sdp: offer}); }
async function handleOffer(from,sdp){ if(!pcMap[from]){ const pc = new RTCPeerConnection(); pc.ondatachannel=e=>{e.channel.onmessage=e=>{appendMessage(from,e.data,false);updateChatJSON();}}; pc.onicecandidate=e=>{if(e.candidate) sendSignal(from,{type:'candidate',candidate:e.candidate});}; pcMap[from]=pc;} const pc=pcMap[from]; await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); sendSignal(from,{type:'answer', sdp: answer}); }
async function handleAnswer(from,sdp){ await pcMap[from]?.setRemoteDescription(new RTCSessionDescription(sdp)); }
async function handleCandidate(from,candidate){ await pcMap[from]?.addIceCandidate(new RTCIceCandidate(candidate)); }
function sendSignal(to,msg){ supabase.channel('public:signaling').send({type:'broadcast',event:'signal',payload:{...msg,from:profile.id,to}}); }

// --- Send / Attach ---
function updateSendIcon(){ if(chatInput.value.trim()){ sendBtn.style.display='flex'; attachBtn.style.display='none'; } else{ sendBtn.style.display='none'; attachBtn.style.display='flex'; } }
sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('input', updateSendIcon);
chatInput.addEventListener('keydown', e=>{if(e.key==='Enter') sendMessage();});
updateSendIcon();
attachBtn.addEventListener('click', ()=>chatFile.click());
chatFile.addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> sendImage(reader.result);
  reader.readAsDataURL(file);
  chatFile.value='';
});

function sendMessage(){ if(!currentPeer) return; const val = chatInput.value.trim(); if(!val) return; appendMessage(currentPeer, val, true, false); dataChannelMap[currentPeer]?.send(val); sendSignal(currentPeer, {type:'message', data:val, isImage:false}); chatInput.value=''; updateSendIcon(); updateChatJSON(); }
function sendImage(data){ if(!currentPeer) return; appendMessage(currentPeer, data, true, true); sendSignal(currentPeer, {type:'message', data, isImage:true}); updateChatJSON(); }

// --- Close & security ---
closeBtn.addEventListener('click', ()=>chatContainer.classList.remove('active'));
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('keydown', e=>{ if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['I','J','C'].includes(e.key.toUpperCase()))||(e.ctrlKey&&['U','S','P'].includes(e.key.toUpperCase()))){ e.preventDefault(); e.stopPropagation(); } });
document.addEventListener('dragstart', e=>e.preventDefault());
document.addEventListener('copy', e=>e.preventDefault());
document.addEventListener('cut', e=>e.preventDefault());
document.addEventListener('paste', e=>e.preventDefault());

// --- Start realtime ---
startRealtime();
</script>


</body>
</html>

