<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root {
    --bg: #f3f4f6;
    --card: #fff;
    --accent: #3b82f6;
    --muted: #6b7280;
    --online: #22c55e;
    --hover: #e5e7eb;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;}
  body{background:var(--bg);display:flex;flex-direction:column;height:100vh;}

  header{
    background:var(--card);
    padding:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    position:sticky;top:0;z-index:10;
  }
  header h1{font-size:1.5rem;color:#111827;}
  .search-container{position:relative;}
  .search-container input{
    width:0; padding:8px; border-radius:8px; border:1px solid #d1d5db;
    transition:0.3s; opacity:0; position:absolute; right:0; top:0;
  }
  .search-container input.show{width:240px; opacity:1;}
  .search-container button{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#6b7280;}

  #chat-list, #search-results{flex:1;overflow-y:auto;padding:8px;}
  .chat-item, .search-item{
    display:flex;align-items:center;padding:10px;background:var(--card);
    border-radius:12px;margin-bottom:8px;cursor:pointer;transition:0.2s;position:relative;
  }
  .chat-item:hover, .search-item:hover{background:var(--hover);}
  .chat-item img, .search-item img{width:50px;height:50px;border-radius:50%;object-fit:cover;}
  .chat-info{margin-left:12px;flex:1;}
  .chat-info .name{font-weight:600;color:#111827;}
  .chat-info .email, .chat-info .last-msg{font-size:0.875rem;color:var(--muted);}
  .chat-time{font-size:0.75rem;color:var(--muted);margin-left:8px;white-space:nowrap;}
  .online-dot{width:12px;height:12px;background:var(--online);border-radius:50%;border:2px solid var(--card);position:absolute;bottom:0;right:0;}

  .no-chat{text-align:center;padding:32px;color:var(--muted);font-weight:500;}
</style>
</head>
<body>

<header>
  <h1>Chats</h1>
  <div class="search-container">
    <button id="search-btn"><i class="fas fa-magnifying-glass"></i></button>
    <input type="text" id="search-input" placeholder="Search by name or email">
  </div>
</header>

<div id="search-results" class="hidden"></div>
<div id="chat-list" class="no-chat">No chat</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://dfzshvldanqfvfivjrqi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA"; // replace with your key
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const MESSAGES_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const MESSAGES_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k"; // replace with your key
const messagesSupabase = createClient(MESSAGES_URL, MESSAGES_KEY);

let hc_profile = JSON.parse(localStorage.getItem('hc_profile') || '{}');

const searchBtn = document.getElementById("search-btn");
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");
const chatList = document.getElementById("chat-list");

searchBtn.addEventListener("click", () => {
  searchInput.classList.toggle("show");
  if(searchInput.classList.contains("show")) searchInput.focus();
  else searchResults.classList.add("hidden");
});

async function searchUsers(query){
  if(!query) return [];
  const { data } = await supabase
    .from('users')
    .select('name,email,profile_url')
    .ilike('name', `%${query}%`)
    .or(`email.ilike.%${query}%`);
  return data || [];
}

function renderUsers(users){
  searchResults.innerHTML = '';
  if(users.length===0) { searchResults.classList.add('hidden'); return; }
  users.forEach(user=>{
    if(user.email === hc_profile.email) return; // skip self
    const div = document.createElement('div');
    div.className='search-item';
    div.innerHTML=`
      <img src="${user.profile_url}">
      <div class="chat-info">
        <div class="name">${user.name}</div>
        <div class="email">${user.email}</div>
      </div>
    `;
    div.addEventListener('click', ()=>window.location.href=`chat.html?name=${encodeURIComponent(user.name)}&email=${encodeURIComponent(user.email)}&profile_url=${encodeURIComponent(user.profile_url)}`);
    searchResults.appendChild(div);
  });
  searchResults.classList.remove('hidden');
}

searchInput.addEventListener('input', async e=>{
  const users = await searchUsers(e.target.value.trim());
  renderUsers(users);
});

async function fetchChatList(){
  const { data } = await messagesSupabase
    .from('messages')
    .select('sender,receiver,message,created_at')
    .or(`sender.eq.${hc_profile.email},receiver.eq.${hc_profile.email}`)
    .order('created_at',{ascending:false});
  if(!data || data.length===0) { chatList.textContent='No chat'; return; }

  const chatMap = new Map();
  data.forEach(msg=>{
    const otherEmail = msg.sender===hc_profile.email ? msg.receiver : msg.sender;
    if(!chatMap.has(otherEmail)) chatMap.set(otherEmail,msg);
  });

  chatList.innerHTML='';
  for(const [email,msg] of chatMap.entries()){
    const { data:userData } = await supabase.from('users').select('name,profile_url').eq('email',email).single();
    if(!userData) continue;
    const div=document.createElement('div');
    div.className='chat-item';
    div.innerHTML=`
      <img src="${userData.profile_url}">
      <div class="chat-info">
        <div class="name">${userData.name}</div>
        <div class="last-msg">${msg.message}</div>
      </div>
      <div class="chat-time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
    `;
    div.addEventListener('click', ()=>window.location.href=`chat.html?name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(email)}&profile_url=${encodeURIComponent(userData.profile_url)}`);
    chatList.appendChild(div);
  }
}

// Realtime online tracking
const channel = supabase.channel('online-status')
  .on('postgres_changes', { event:'UPDATE', schema:'public', table:'users' }, payload=>{
    fetchChatList();
  })
  .subscribe();

fetchChatList();
</script>
</body>
</html>
