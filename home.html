<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root {
    --bg: #f3f4f6;
    --card: #fff;
    --muted: #6b7280;
    --hover: #e5e7eb;
  }

  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;}
  body{background:var(--bg);display:flex;justify-content:center;align-items:flex-start;height:100vh;padding-top:50px;}

  .card {
    width: 50%;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    max-height: 600px; /* Fixed height */
    overflow: hidden;
  }

  header{
    background: var(--card);
    padding:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
    position: sticky;
    top:0;
    z-index:10;
  }
  header h1{font-size:1.5rem;color:#111827;}
  header button{
    background:none;
    border:none;
    font-size:1.2rem;
    cursor:pointer;
    color:var(--muted);
  }

  #chat-list{
    flex:1;
    overflow-y:auto;
    padding:8px;
  }

  .chat-item{
    display:flex;align-items:center;padding:10px;background:var(--card);
    border-radius:12px;margin-bottom:8px;cursor:pointer;transition:0.2s;
  }
  .chat-item:hover{background:var(--hover);}
  .chat-item img{width:50px;height:50px;border-radius:50%;object-fit:cover;}
  .chat-info{margin-left:12px;flex:1;}
  .chat-info .name{font-weight:600;color:#111827;}
  .chat-info .last-msg{font-size:0.875rem;color:var(--muted);}
  .chat-time{font-size:0.75rem;color:var(--muted);white-space:nowrap;}

  .no-chat{text-align:center;padding:32px;color:var(--muted);font-weight:500;}
</style>
</head>
<body>

<div class="card">
  <header>
    <h1>Chats</h1>
    <button id="search-btn"><i class="fas fa-magnifying-glass"></i></button>
  </header>

  <div id="chat-list" class="no-chat">No chat</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const MESSAGES_URL = "https://ilgkibqwngznqwnhgavh.supabase.co";
const MESSAGES_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k";
const messagesSupabase = createClient(MESSAGES_URL, MESSAGES_KEY);

let hc_profile = JSON.parse(localStorage.getItem('hc_profile') || '{}');

const chatList = document.getElementById("chat-list");
const searchBtn = document.getElementById("search-btn");

searchBtn.addEventListener('click', () => {
  window.location.href = 'search.html';
});

async function fetchChatList(){
  const { data } = await messagesSupabase
    .from('messages')
    .select('sender,receiver,message,created_at')
    .or(`sender.eq.${hc_profile.email},receiver.eq.${hc_profile.email}`)
    .order('created_at', { ascending: false });

  if(!data || data.length === 0){
    chatList.textContent = 'No chat';
    return;
  }

  const chatMap = new Map();
  data.forEach(msg => {
    const otherEmail = msg.sender === hc_profile.email ? msg.receiver : msg.sender;
    if(!chatMap.has(otherEmail)) chatMap.set(otherEmail, msg);
  });

  chatList.innerHTML = '';
  for(const [email, msg] of chatMap.entries()){
    const { data:userData } = await messagesSupabase
      .from('users')
      .select('name, profile_url')
      .eq('email', email)
      .single();
    if(!userData) continue;

    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `
      <img src="${userData.profile_url}">
      <div class="chat-info">
        <div class="name">${userData.name}</div>
        <div class="last-msg">${msg.message}</div>
      </div>
      <div class="chat-time">${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    div.addEventListener('click', () => {
      window.location.href = `chat.html?name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(email)}&profile_url=${encodeURIComponent(userData.profile_url)}`;
    });
    chatList.appendChild(div);
  }
}

messagesSupabase
  .channel('user-presence')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload => {
    console.log("User update detected:", payload);
    fetchChatList();
  })
  .subscribe();

fetchChatList();
</script>
</body>
</html>
