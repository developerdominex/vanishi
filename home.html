<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hybrid â€” Chat</title>
<link rel="icon" href="hybrid.png" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#e6eefc;
  --side:#ffffff;
  --card:#ffffff;
  --primary:#2b9cff;
  --primary-600:#257ed6;
  --muted:#6b7280;
  --shadow:0 12px 30px rgba(16,24,40,0.08);
  --radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;}
html,body{height:100%;}
body{background: linear-gradient(180deg, #f6fbff 0%, #e6eefc 100%); display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden; padding:24px;}
.app { width:100%; max-width:1100px; height:100%; max-height:800px; background:transparent; display:grid; grid-template-columns: 320px 1fr; gap:20px; align-items:stretch; }
.panel { background:var(--side); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; }
.panel .header { padding:18px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(15,23,42,0.04); }
.panel .header .title{ font-weight:700;color:#0f172a; font-size:16px; }
.panel .header .subtitle{ color:var(--muted);font-size:12px;margin-top:4px; }
.search { padding:12px 14px;border-bottom:1px solid rgba(15,23,42,0.04); display:flex;gap:8px;align-items:center; }
.search input{ flex:1;border-radius:12px;padding:10px 12px;border:1px solid rgba(15,23,42,0.06); outline:none;background:#fbfdff;font-size:14px;color:#071133; transition:box-shadow .18s ease; }
.search input:focus{box-shadow:0 6px 18px rgba(43,156,255,0.12);border-color:var(--primary-600);}
.list { padding:12px; flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px; }
.contact { display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;cursor:pointer; transition:background .12s ease, transform .12s ease; }
.contact:hover{ background:rgba(43,156,255,0.04); transform:translateY(-2px);}
.contact.selected{ background:linear-gradient(90deg,var(--primary) 0%, var(--primary-600) 100%); color:white; box-shadow:0 10px 30px rgba(43,156,255,0.12); }
.avatar{ width:48px;height:48px;border-radius:50%;flex-shrink:0;object-fit:cover;box-shadow:0 6px 18px rgba(2,6,23,0.06); }
.meta{ display:flex;flex-direction:column; gap:4px; min-width:0; }
.meta .name{ font-weight:600; font-size:15px; color:#071133; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.contact.selected .name{ color:white; }
.meta .last{ color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.contact.selected .last{ color:rgba(255,255,255,0.9); }
.chat { background:linear-gradient(180deg,#ffffff, #f7fbff); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;display:flex;flex-direction:column; }
.chat .top { padding:14px 18px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(15,23,42,0.04); }
.chat .top img{ width:44px;height:44px;border-radius:50%;object-fit:cover; display:block; }
.chat .top .who{ display:flex;flex-direction:column;}
.chat .top .who .n{ font-weight:700; color:#071133; }
.chat .top .who .s{ font-size:13px;color:var(--muted); }
.chat .body { padding:20px; flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; background:linear-gradient(180deg,#f7fbff00,#ffffff00); }
.messages{ display:flex; flex-direction:column; gap:8px; width:100%; max-width:820px; margin-top:auto; margin-bottom:auto;}
.msg { display:inline-block; max-width:72%; padding:12px 14px; border-radius:18px; font-size:15px; line-height:1.3; box-shadow:0 6px 20px rgba(2,6,23,0.06); opacity:0; transform:translateY(8px); animation:pop .22s ease forwards; }
@keyframes pop{ to{ opacity:1; transform:none; } }
.msg.me{ background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:white; align-self:flex-end; border-bottom-right-radius:6px;}
.msg.other{ background:#fff; color:#071133; align-self:flex-start; border-bottom-left-radius:6px;}
.msg img{ max-width:300px;border-radius:12px; display:block; }
.time{ font-size:11px;color:var(--muted); margin-top:6px; opacity:0.9;}
.composer { padding:12px; border-top:1px solid rgba(15,23,42,0.04); display:flex; gap:8px; align-items:center; background:linear-gradient(180deg, #ffffff, #f7fbff); }
.input { flex:1; background:#f3f6ff; padding:10px 14px; border-radius:999px; display:flex; gap:8px; align-items:center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
.input input{ flex:1; border:none; background:transparent; outline:none; font-size:15px; color:#071133;}
.icon-btn{ width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:none; background:transparent; color:var(--primary); font-size:18px; }
.send{ width:48px;height:44px;border-radius:12px; display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:white; font-size:18px; border:none; cursor:pointer; box-shadow:0 10px 24px rgba(43,156,255,0.14); }
.placeholder{ display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:15px;}
@media (max-width:900px){ .app{ grid-template-columns: 1fr; gap:12px; align-items:stretch; max-width:720px; padding:12px; } .panel{ order:2; height:38vh; border-radius:12px; } .chat{ order:1; height:60vh; border-radius:12px; } }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="panel" id="sidebar">
    <div class="header">
      <div style="display:flex;flex-direction:column">
        <div class="title">Hybrid</div>
        <div class="subtitle">messaging</div>
      </div>
    </div>
    <div class="search">
      <input id="search" placeholder="Search people or paste id..." autocomplete="off">
      <button class="icon-btn" id="addBtn" title="Add by ID"><i class="fas fa-user-plus"></i></button>
    </div>
    <div class="list" id="contacts"></div>
    <div style="padding:12px;border-top:1px dashed rgba(15,23,42,0.04);display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div style="display:flex;gap:8px;align-items:center">
        <img id="myAvatar" src="" style="width:42px;height:42px;border-radius:50%;object-fit:cover">
        <div style="font-size:13px;color:#071133;font-weight:600" id="myName"></div>
      </div>
      <button id="logout" class="icon-btn" style="background:#fff;color:#ef4444;border-radius:10px;"><i class="fas fa-right-from-bracket"></i></button>
    </div>
  </div>
  <div class="chat" id="chat">
    <div class="top">
      <img id="peerAvatar" src="" alt="avatar" style="display:none">
      <div class="who">
        <div class="n" id="peerName">Select a contact</div>
        <div class="s" id="peerStatus"></div>
      </div>
    </div>
    <div class="body" id="chatBody">
      <div class="placeholder" id="placeholder">Select a contact to start chatting.</div>
      <div class="messages" id="messages" style="display:none"></div>
    </div>
    <div class="composer">
      <div class="input">
        <input id="messageInput" placeholder="Type a message..." autocomplete="off">
      </div>
      <button class="icon-btn" id="attach"><i class="fas fa-paperclip"></i></button>
      <button class="send" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://dfzshvldanqfvfivjrqi.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)
const storageProfileKey='hc_profile', DRIVE_FILE_NAME='chat.json'
const profile=JSON.parse(localStorage.getItem(storageProfileKey)||'null')
if(!profile){location.href='register.html';throw new Error('No profile')}
const myId=profile.id,myName=profile.name,myEmail=profile.email||'',myAvatar=profile.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(profile.name)}`,DRIVE_TOKEN=profile.token||null
let DRIVE_FILE_ID=null, chatStore={}; // main data

// DOM
const contactsEl=document.getElementById('contacts'), searchEl=document.getElementById('search'), addBtn=document.getElementById('addBtn'), logoutBtn=document.getElementById('logout'), peerAvatarEl=document.getElementById('peerAvatar'), peerNameEl=document.getElementById('peerName'), peerStatusEl=document.getElementById('peerStatus'), placeholderEl=document.getElementById('placeholder'), messagesEl=document.getElementById('messages'), messageInput=document.getElementById('messageInput'), sendBtn=document.getElementById('sendBtn'), attachBtn=document.getElementById('attach')
let online={},currentPeer=null,pcMap={},dcMap={},typingStatus={}

// Profile
document.getElementById('myAvatar').src=myAvatar
document.getElementById('myName').textContent=myName

// Contacts
searchEl.addEventListener('input',()=>renderContacts(searchEl.value.trim()))
addBtn.addEventListener('click',()=>{
  const id=searchEl.value.trim(); if(!id||id===myId) return
  if(!chatStore[id]) chatStore[id]={ profile:{uuid:id,name:'Contact',avatar:`https://ui-avatars.com/api/?name=User`,email:''}, messages:[] }
  saveToDrive(); renderContacts()
})
logoutBtn.addEventListener('click',()=>{ localStorage.removeItem(storageProfileKey); location.href='register.html' })
function renderContacts(filter='',tab='chats'){
  contactsEl.innerHTML=''
  const list=Object.values(chatStore)
  .filter(c=>tab==='online'?online[c.profile.uuid]:true)
  .filter(c=>!filter||c.profile.name.toLowerCase().includes(filter.toLowerCase())||c.profile.uuid.includes(filter))
  .sort((a,b)=>((b.messages.slice(-1)[0]?.ts||0)-(a.messages.slice(-1)[0]?.ts||0)))
  list.forEach(c=>{
    const u=c.profile, div=document.createElement('div'); div.className='contact'
    if(currentPeer===u.uuid) div.classList.add('selected')
    const lastMsg=c.messages.slice(-1)[0]?.text||'No messages yet'
    const status=online[u.uuid]?'Online':(c.lastSeen?`Last seen ${new Date(c.lastSeen).toLocaleTimeString()}`:'Offline')
    div.innerHTML=`<img class="avatar" src="${u.avatar}">
      <div class="meta"><div class="name">${u.name}</div><div class="last">${lastMsg}</div></div>`
    div.addEventListener('click',()=>openChatWith(u.uuid))
    contactsEl.appendChild(div)
  })
}
function openChatWith(peerId){
  currentPeer=peerId; const peer=chatStore[peerId].profile
  peerNameEl.textContent=peer.name
  peerAvatarEl.src=peer.avatar; peerAvatarEl.style.display='block'
  peerStatusEl.textContent=online[peerId]?'Online':(chatStore[peerId].lastSeen?`Last seen ${new Date(chatStore[peerId].lastSeen).toLocaleTimeString()}`:'Offline')
  placeholderEl.style.display='none'; messagesEl.style.display='flex'; messagesEl.innerHTML=''
  chatStore[peerId].messages.forEach(m=>renderMessage(m.text,m.me,m.isImage,false))
  if(!pcMap[peerId]) createConnection(peerId)
  renderContacts(); scrollToBottom()
}
function renderMessage(text,me,isImage,animate=true){
  const d=document.createElement('div'); d.className='msg '+(me?'me':'other')
  if(isImage){ const img=document.createElement('img'); img.src=text; d.appendChild(img) } else d.textContent=text
  if(animate) d.style.opacity=0; messagesEl.appendChild(d)
  if(animate) requestAnimationFrame(()=>{ d.style.opacity=1 }); scrollToBottom()
}
function scrollToBottom(){ messagesEl.scrollTop=messagesEl.scrollHeight }
messageInput.addEventListener('input',()=>{ if(currentPeer) sendSignal(currentPeer,{type:'typing'}) })
function showTyping(peerId){ peerStatusEl.textContent='Typing...'; clearTimeout(typingStatus[peerId]); typingStatus[peerId]=setTimeout(()=>{ peerStatusEl.textContent=online[peerId]?'Online':(chatStore[peerId].lastSeen?`Last seen ${new Date(chatStore[peerId].lastSeen).toLocaleTimeString()}`:'Offline') },1000) }

// Messaging
function generateMsgId(text,ts,me){ return btoa(`${text}-${ts}-${me?'me':'peer'}`) }
function appendIncoming(from,text,isImage,ts=null,id=null){
  if(!chatStore[from]) chatStore[from]={ profile:{uuid:from,name:'Contact',avatar:`https://ui-avatars.com/api/?name=User`,email:''}, messages:[] }
  ts=ts||Date.now(); id=id||generateMsgId(text,ts,false)
  if(chatStore[from].messages.some(m=>m.id===id)) return
  chatStore[from].messages.push({id,text,me:false,isImage:!!isImage,ts})
  if(currentPeer===from) renderMessage(text,false,!!isImage)
  else flashContact(from)
  saveToDrive(); renderContacts()
}
function sendMessage(){
  if(!currentPeer) return
  const val=messageInput.value.trim(); if(!val) return
  const ts=Date.now(), id=generateMsgId(val,ts,true)
  chatStore[currentPeer].messages.push({id,text:val,me:true,isImage:false,ts})
  renderMessage(val,true,false)
  if(dcMap[currentPeer]?.readyState==='open') dcMap[currentPeer].send(JSON.stringify({text:val,isImage:false,ts,id}))
  sendSignal(currentPeer,{type:'message',data:val,isImage:false,ts,id})
  messageInput.value=''; saveToDrive(); renderContacts()
}
sendBtn.addEventListener('click',sendMessage)
messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage() })

function sendImageAsMessage(dataUrl){
  if(!currentPeer) return
  const ts=Date.now(), id=generateMsgId(dataUrl,ts,true)
  chatStore[currentPeer].messages.push({id,text:dataUrl,me:true,isImage:true,ts})
  renderMessage(dataUrl,true,true)
  if(dcMap[currentPeer]?.readyState==='open') dcMap[currentPeer].send(JSON.stringify({text:dataUrl,isImage:true,ts,id}))
  sendSignal(currentPeer,{type:'message',data:dataUrl,isImage:true,ts,id})
  saveToDrive(); renderContacts()
}
attachBtn.addEventListener('click',()=>{ const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>sendImageAsMessage(r.result); r.readAsDataURL(f) }; input.click() })

function flashContact(id){ const el=[...contactsEl.children].find(c=>c.querySelector('.avatar')&&c.innerText.includes(id)); if(el) el.animate([{transform:'scale(1)'},{transform:'scale(1.02)'},{transform:'scale(1)'}],{duration:300}) }

// WebRTC & Supabase
async function startRealtime(){
  if(!DRIVE_TOKEN){ logoutInvalidToken(); return }
  const pres=supabase.channel('public:presence')
  pres.on('broadcast',{event:'user-presence'},payload=>{
    const u=payload.payload
    if(!u?.uuid) return
    if(u.action==='join'||u.action==='update'){ online[u.uuid]=true; chatStore[u.uuid]=chatStore[u.uuid]||{profile:u,messages:[]}; renderContacts() }
    else if(u.action==='leave'){ online[u.uuid]=false; chatStore[u.uuid].lastSeen=Date.now(); renderContacts() }
  })
  const sig=supabase.channel('public:signaling')
  sig.on('broadcast',{event:'signal'},async payload=>{
    const msg=payload.payload; if(!msg||msg.to!==myId) return
    if(msg.type==='offer') await handleOffer(msg.from,msg.sdp)
    else if(msg.type==='answer') await handleAnswer(msg.from,msg.sdp)
    else if(msg.type==='candidate') await handleCandidate(msg.from,msg.candidate)
    else if(msg.type==='message') appendIncoming(msg.from,msg.data,msg.isImage,msg.ts,msg.id)
    else if(msg.type==='typing') showTyping(msg.from)
  })
  await pres.subscribe(); await sig.subscribe()
  broadcastPresence('join'); setInterval(()=>broadcastPresence('update'),25000)
  window.addEventListener('beforeunload',()=>broadcastPresence('leave'))
  await fetchDriveChat()
}
function broadcastPresence(action){ supabase.channel('public:presence').send({type:'broadcast',event:'user-presence',payload:{uuid:myId,name:myName,email:myEmail,avatar:myAvatar,action,ts:Date.now()}}) }

// WebRTC helpers
function createConnection(peer){
  const pc=new RTCPeerConnection(), dc=pc.createDataChannel('chat')
  dc.onmessage=ev=>{ const d=JSON.parse(ev.data); appendIncoming(peer,d.text,d.isImage,d.ts,d.id) }
  dc.onopen=()=>{ dcMap[peer]=dc }
  pc.onicecandidate=e=>{ if(e.candidate) sendSignal(peer,{type:'candidate',candidate:e.candidate}) }
  pc.ondatachannel=e=>{ e.channel.onmessage=ev=>{ const d=JSON.parse(ev.data); appendIncoming(peer,d.text,d.isImage,d.ts,d.id) }; e.channel.onopen=()=>{ dcMap[peer]=e.channel } }
  pcMap[peer]=pc; makeOffer(peer)
}
async function makeOffer(peer){ const pc=pcMap[peer]; if(!pc) return; const offer=await pc.createOffer(); await pc.setLocalDescription(offer); sendSignal(peer,{type:'offer',sdp:offer}) }
async function handleOffer(from,sdp){ if(!pcMap[from]){ const pc=new RTCPeerConnection(); pc.ondatachannel=e=>{ e.channel.onmessage=ev=>{ const d=JSON.parse(ev.data); appendIncoming(from,d.text,d.isImage,d.ts,d.id) }; e.channel.onopen=()=>{ dcMap[from]=e.channel } }; pc.onicecandidate=e=>{ if(e.candidate) sendSignal(from,{type:'candidate',candidate:e.candidate}) }; pcMap[from]=pc } const pc=pcMap[from]; await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); sendSignal(from,{type:'answer',sdp:answer}) }
async function handleAnswer(from,sdp){ await pcMap[from]?.setRemoteDescription(new RTCSessionDescription(sdp)) }
async function handleCandidate(from,candidate){ await pcMap[from]?.addIceCandidate(new RTCIceCandidate(candidate)) }
function sendSignal(to,msg){ supabase.channel('public:signaling').send({type:'broadcast',event:'signal',payload:{...msg,from:myId,to}}) }

// Drive
async function fetchDriveChat(){
  if(!DRIVE_TOKEN){ logoutInvalidToken(); return }
  try{
    const listRes=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}' and trashed=false&fields=files(id,name)`,{headers:{Authorization:'Bearer '+DRIVE_TOKEN}})
    const listData=await listRes.json(); DRIVE_FILE_ID=listData.files?.[0]?.id||null
    if(DRIVE_FILE_ID){
      const fileRes=await fetch(`https://www.googleapis.com/drive/v3/files/${DRIVE_FILE_ID}?alt=media`,{headers:{Authorization:'Bearer '+DRIVE_TOKEN}})
      if(fileRes.ok){
        const data=await fileRes.json().catch(()=>({})); if(typeof data==='object') chatStore=data; renderContacts()
      } else logoutInvalidToken()
    } else saveToDrive()
  }catch(e){ logoutInvalidToken() }
}
async function saveToDrive(){
  if(!DRIVE_TOKEN){ logoutInvalidToken(); return }
  try{
    const metadata={name:DRIVE_FILE_NAME,mimeType:'application/json'}
    const form=new FormData(); form.append('metadata',new Blob([JSON.stringify(metadata)],{type:'application/json'})); form.append('file',new Blob([JSON.stringify(chatStore)],{type:'application/json'}))
    const uploadUrl=DRIVE_FILE_ID?`https://www.googleapis.com/upload/drive/v3/files/${DRIVE_FILE_ID}?uploadType=multipart`:`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`
    const res=await fetch(uploadUrl,{method:DRIVE_FILE_ID?'PATCH':'POST',headers:{Authorization:'Bearer '+DRIVE_TOKEN},body:form})
    if(res.ok){ const j=await res.json(); DRIVE_FILE_ID=j.id||DRIVE_FILE_ID } else logoutInvalidToken()
  }catch(e){ logoutInvalidToken() }
}
function logoutInvalidToken(){ localStorage.removeItem(storageProfileKey); location.href='register.html' }

// Init
startRealtime()
</script>
</body>
</html>
