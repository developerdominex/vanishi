<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Starlight</title>
<link rel="icon" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{
  --bg:#f3f4f6;
  --card:#fff;
  --muted:#6b7280;
  --accent:#2563eb;
  --hover:#eef2ff;
  --online:#22c55e;
  --offline:#6b7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
body{min-height:100vh;background:var(--bg);display:flex;align-items:flex-start;justify-content:center;padding:48px 16px}
.card{width:520px;height:calc(100vh-80px);max-width:96vw;background:var(--card);border-radius:12px;box-shadow:0 18px 48px rgba(2,6,23,0.12);overflow:hidden;display:flex;flex-direction:column}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(15,23,42,0.04)}
header .title{font-size:18px;font-weight:700;color:#0f172a}
header .controls{display:flex; gap:10px;align-items:center}
.btn{background:transparent;border:0;font-size:16px;cursor:pointer;color:var(--muted);padding:6px;border-radius:8px}
.btn:hover{background:#f1f5f9}
#chat-list{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:transparent;cursor:pointer;transition:background .12s}
.item:hover{background:var(--hover)}
.avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;flex-shrink:0}
.meta{display:flex;flex-direction:column;min-width:0}
.meta .name{font-weight:700;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .msg{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.time{font-size:12px;color:var(--muted);margin-left:auto;white-space:nowrap}
.status-dot{width:10px;height:10px;border-radius:50%;margin-left:4px;flex-shrink:0}
.no-chat{display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-weight:600}
.error{padding:12px;color:#b91c1c}
</style>
</head>
<body>

<div class="card">
  <header>
    <div class="title">Chats</div>
    <div class="controls">
      <button id="searchBtn" class="btn" title="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
      <button id="refreshBtn" class="btn" title="Refresh"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
  </header>

  <div id="chat-list">
    <div class="no-chat">Loading chats…</div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// Supabase endpoints
const MSG_REST_URL = 'https://ilgkibqwngznqwnhgavh.supabase.co/rest/v1';
const MSG_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsZ2tpYnF3bmd6bnF3bmhnYXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzU3NDcsImV4cCI6MjA3NzA1MTc0N30.jFHL4VDU81BRqxpoWc4u_4VYG4sI-SB0-EkxSfPGZ5k';

const USERS_REST_URL = 'https://dfzshvldanqfvfivjrqi.supabase.co/rest/v1';
const USERS_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA';

const SUPABASE_URL = 'https://ilgkibqwngznqwnhgavh.supabase.co';
const SUPABASE_KEY = MSG_ANON; 
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const chatListEl = document.getElementById('chat-list');
const searchBtn = document.getElementById('searchBtn');
const refreshBtn = document.getElementById('refreshBtn');

const me = JSON.parse(localStorage.getItem('hc_profile') || '{}');
if(!me.email){ window.location.href='register.html'; }

// Helper to quote
const q = v=>`"${String(v).replace(/"/g,'""')}"`;

// Fetch messages for current user
async function fetchMessages(){
  const orRaw = `(sender.eq.${q(me.email)},receiver.eq.${q(me.email)})`;
  const qs = `select=sender,receiver,message,created_at&order=created_at.desc&limit=1000&or=${encodeURIComponent(orRaw)}`;
  const res = await fetch(`${MSG_REST_URL}/messages?${qs}`,{
    headers:{apikey:MSG_ANON,'Authorization':'Bearer '+MSG_ANON,'Accept':'application/json'}
  });
  if(!res.ok) throw new Error('Failed to fetch messages');
  return res.json();
}

// Fetch user profile from users table
async function fetchUserProfile(email){
  const qs = `select=name,profile_url&email=eq.${encodeURIComponent(email)}&limit=1`;
  const res = await fetch(`${USERS_REST_URL}/users?${qs}`,{
    headers:{apikey:USERS_ANON,'Authorization':'Bearer '+USERS_ANON,'Accept':'application/json'}
  });
  if(!res.ok) return {name:email, profile_url:''};
  const data = await res.json();
  return data[0] || {name:email,profile_url:''};
}

async function loadChatList(){
  chatListEl.innerHTML=`<div class="no-chat">Loading chats…</div>`;
  try{
    const msgs = await fetchMessages();
    if(!msgs.length){ chatListEl.innerHTML=`<div class="no-chat">No chat</div>`; return; }

    // Map latest message per other user
    const chatMap = new Map();
    for(const m of msgs){
      const other = (m.sender===me.email)?m.receiver:m.sender;
      if(!chatMap.has(other)) chatMap.set(other, m);
    }

    chatListEl.innerHTML='';
    for(const [otherEmail, recentMsg] of chatMap.entries()){
      const profile = await fetchUserProfile(otherEmail);

      const item = document.createElement('div');
      item.className='item';
      item.innerHTML=`
        <img class="avatar" src="${profile.profile_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.name)}`}" alt="avatar">
        <div class="meta">
          <div class="name">${profile.name} <span class="status-dot" id="status-${otherEmail.replace(/[@.]/g,'-')}"></span></div>
          <div class="msg">${recentMsg.message}</div>
        </div>
        <div class="time">${new Date(recentMsg.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
      `;
      item.addEventListener('click',()=> {
        const params = new URLSearchParams({name:profile.name,email:otherEmail,profile_url:profile.profile_url});
        location.href=`chat.html?${params.toString()}`;
      });
      chatListEl.appendChild(item);
    }
    setupRealtimeStatus([...chatMap.keys()]);
  }catch(e){console.error(e); chatListEl.innerHTML=`<div class="error">Unable to load chats</div>`;}
}

searchBtn.addEventListener('click',()=>location.href='search.html');
refreshBtn.addEventListener('click',loadChatList);

// Realtime online/offline status
function setupRealtimeStatus(emails){
  const channel = supabase.channel('user-presence');
  channel.subscribe();
  emails.forEach(email=>{
    const dot = document.getElementById(`status-${email.replace(/[@.]/g,'-')}`);
    dot.style.backgroundColor = '--offline';
  });

  channel.on('postgres_changes', { event:'*', schema:'public', table:'users' }, payload=>{
    if(!payload.new?.email) return;
    const dot = document.getElementById(`status-${payload.new.email.replace(/[@.]/g,'-')}`);
    if(dot) dot.style.backgroundColor = '--online';
  });
}

await loadChatList();
</script>
</body>
</html>
