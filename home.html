<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Realtime Chat â€” Animated</title>
<link rel="icon" type="image/png" href="hybrid.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg:#f0f2f5;
  --card:#ffffff;
  --accent:#6366f1;
  --accent-hover:#4f46e5;
  --text:#111827;
  --text-muted:#6b7280;
  --input-bg:#f3f4f6;
  --shadow:rgba(0,0,0,0.1);
  --border:#d1d5db;
  --online:#10b981;
  --radius:16px;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,sans-serif;}

/* Body */
body{display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text);overflow:hidden;}

/* Top bar */
#topBar{
  height:60px;
  background:var(--card);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  box-shadow:0 2px 6px var(--shadow);
  position:fixed;
  width:100%;
  top:0;
  z-index:1000;
  animation: slideDown 0.6s ease;
}
#topBar h1{font-size:20px;font-weight:700;color:var(--accent);}
#topBar button{padding:6px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;transition:0.3s;}
#topBar button:hover{background:var(--accent-hover);transform:scale(1.05);}

/* Slide down animation */
@keyframes slideDown{from{transform:translateY(-100%);}to{transform:translateY(0);}}

/* Main container */
#main{display:flex;flex:1;margin-top:60px;overflow:hidden;height:calc(100vh - 60px);}

/* Users panel */
#usersPanel{
  width:300px;
  background:var(--card);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  transition:all 0.3s ease;
  overflow-y:auto;
}
#usersPanel header{padding:16px;font-weight:600;font-size:18px;border-bottom:1px solid var(--border);}
#usersPanel input{margin:12px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--input-bg);outline:none;font-size:14px;transition:0.3s;}
.user-item{
  display:flex;align-items:center;padding:10px 12px;gap:12px;cursor:pointer;border-radius:12px;transition:all 0.2s;
  animation: fadeIn 0.5s ease forwards; opacity:0; transform:translateX(-20px);
}
.user-item:hover{background:var(--input-bg);}
.user-item.selected{background:var(--accent-hover);color:#fff;}
.user-item img{width:50px;height:50px;border-radius:50%;object-fit:cover;}
.user-meta{display:flex;flex-direction:column;flex:1;overflow:hidden;}
.user-meta strong{display:flex;justify-content:space-between;font-size:16px;}
.user-meta span{font-size:13px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Chat panel */
#chatPanel{flex:1;display:flex;flex-direction:column;position:relative;transition:all 0.3s ease;background:var(--bg);}
#chatHeader{
  display:flex;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border);
  box-shadow:0 1px 3px var(--shadow);position:sticky;top:0;z-index:10;
}
#chatHeader img{width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:12px;transition:0.3s;}
#chatHeader .info{display:flex;flex-direction:column;}
#chatHeader .info strong{font-size:16px;}
#chatHeader .info span{font-size:12px;color:var(--online);}

/* Chat body */
#chatBody{
  flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;
}
#chatBody.placeholder{justify-content:center;align-items:center;color:var(--text-muted);font-size:18px;}

/* Messages */
.msg{max-width:70%;padding:10px 14px;border-radius:16px;word-break:break-word;background:var(--card);box-shadow:0 1px 3px var(--shadow);opacity:0;transform:translateY(20px);animation:msgIn 0.4s forwards;}
.msg.me{align-self:flex-end;background:var(--accent-hover);color:#fff;}
.msg.received{align-self:flex-start;background:var(--card);}
.msg img{max-width:250px;border-radius:12px;transition:0.3s;}
@keyframes msgIn{to{opacity:1;transform:translateY(0);}}

/* Chat controls */
#chatControls{display:flex;gap:8px;padding:12px;background:var(--card);border-top:1px solid var(--border);}
#chatInput{flex:1;padding:10px 16px;border-radius:50px;border:1px solid var(--border);background:var(--input-bg);outline:none;font-size:14px;transition:0.3s;}
#sendBtn,#attachBtn{width:45px;height:45px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:0.3s;}
#sendBtn{background:var(--accent);color:#fff;}
#attachBtn{background:var(--input-bg);color:var(--text-muted);}
#sendBtn:hover{transform:scale(1.1);}
#attachBtn:hover{transform:scale(1.1);}
#chatFile{display:none;}

/* Scrollbars */
#chatBody::-webkit-scrollbar,#usersPanel::-webkit-scrollbar{width:6px;}
#chatBody::-webkit-scrollbar-thumb,#usersPanel::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1);border-radius:3px;}

/* Mobile */
@media(max-width:768px){
  #usersPanel{position:fixed;left:-300px;top:60px;bottom:0;z-index:1000;box-shadow:0 8px 24px var(--shadow);}
  #usersPanel.active{left:0;}
  #chatPanel{flex:1;position:relative;}
  #chatPanel.active{margin-left:0;}
}
</style>
</head>
<body>

<div id="topBar">
  <h1>Realtime Chat</h1>
  <button id="logoutBtn">Logout</button>
</div>

<div id="main">
  <div id="usersPanel">
    <header>Online Users</header>
    <input type="text" id="searchUser" placeholder="Search users...">
    <div id="usersList"></div>
  </div>

  <div id="chatPanel">
    <div id="chatHeader">
      <img id="chatAvatar" src="" alt="avatar">
      <div class="info">
        <strong id="chatName">Select a user</strong>
        <span id="chatStatus"></span>
      </div>
    </div>
    <div id="chatBody" class="placeholder">Select a user to start chatting</div>
    <div id="chatControls">
      <input type="text" id="chatInput" placeholder="Type a message...">
      <button id="attachBtn"><i class="fas fa-paperclip"></i></button>
      <input type="file" id="chatFile" accept="image/*">
      <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://dfzshvldanqfvfivjrqi.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA'
const supabase = createClient(supabaseUrl,supabaseKey)

let profile = JSON.parse(localStorage.getItem('hc_profile')||'null')
if(!profile) location.href='register.html'

let onlineUsers = {}, pcMap={}, dataChannelMap={}, chatHistory=JSON.parse(localStorage.getItem('hc_chat')||'{}'), currentPeer=null, typingTimeout

const usersList=document.getElementById('usersList')
const searchUser=document.getElementById('searchUser')
const chatName=document.getElementById('chatName')
const chatStatus=document.getElementById('chatStatus')
const chatAvatar=document.getElementById('chatAvatar')
const chatBody=document.getElementById('chatBody')
const chatInput=document.getElementById('chatInput')
const sendBtn=document.getElementById('sendBtn')
const attachBtn=document.getElementById('attachBtn')
const chatFile=document.getElementById('chatFile')

// Render users
searchUser.addEventListener('input',()=>renderUsers(searchUser.value.trim()))
function renderUsers(filter=''){
  usersList.innerHTML=''
  Object.values(onlineUsers)
    .filter(u=>u.uuid!==profile.uuid && (!filter || u.name.toLowerCase().includes(filter.toLowerCase())))
    .forEach(u=>{
      const div=document.createElement('div')
      div.className='user-item'
      div.innerHTML=`<img src="${u.avatar}"><div class="user-meta"><strong>${u.name}</strong></div>`
      div.addEventListener('click',()=>openChat(u,div))
      usersList.appendChild(div)
      setTimeout(()=>{div.style.opacity=1; div.style.transform='translateX(0)';},100)
    })
}

// Open chat
function openChat(user,element){
  document.querySelectorAll('.user-item').forEach(e=>e.classList.remove('selected'))
  element.classList.add('selected')
  currentPeer=user.uuid
  chatName.textContent=user.name
  chatAvatar.src=user.avatar
  chatStatus.textContent='Online'
  chatBody.classList.remove('placeholder')
  chatBody.innerHTML=''
  if(!chatHistory[currentPeer]) chatHistory[currentPeer]=[]
  chatHistory[currentPeer].forEach(msg=>appendMessage(msg.text,msg.me,msg.isImage,false))
  if(!pcMap[user.uuid]) createPeerConnection(user.uuid)
}

// Append message
function appendMessage(text,me=false,isImage=false,save=true){
  const div=document.createElement('div')
  div.className='msg '+(me?'me':'received')
  if(isImage){const img=document.createElement('img');img.src=text;div.appendChild(img)}
  else div.textContent=text
  chatBody.appendChild(div)
  chatBody.scrollTop=chatBody.scrollHeight
  if(save && currentPeer){
    chatHistory[currentPeer].push({text,me,isImage,ts:Date.now(),read:me})
    localStorage.setItem('hc_chat',JSON.stringify(chatHistory))
  }
}

// Send message
sendBtn.addEventListener('click',()=>{if(currentPeer){const val=chatInput.value.trim();if(val){appendMessage(val,true);dataChannelMap[currentPeer]?.send(val);chatInput.value='';}}})
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'){sendBtn.click()}})

// Attach image
attachBtn.addEventListener('click',()=>chatFile.click())
chatFile.addEventListener('change',e=>{
  const file=e.target.files[0];if(!file) return
  const reader=new FileReader()
  reader.onload=()=>{appendMessage(reader.result,true,true); dataChannelMap[currentPeer]?.send(reader.result)}
  reader.readAsDataURL(file)
  chatFile.value=''
})

// Real-time presence & signaling
async function startRealtime(){
  const presence = supabase.channel('public:presence')
  presence.on('broadcast',{event:'user-presence'},payload=>{
    const u=payload.payload
    if(!u?.uuid) return
    if(u.action==='join'||u.action==='update'){onlineUsers[u.uuid]={...u}; renderUsers(searchUser.value.trim())}
    else if(u.action==='leave'){delete onlineUsers[u.uuid]; renderUsers(searchUser.value.trim())}
  })

  const signaling = supabase.channel('public:signaling')
  signaling.on('broadcast',{event:'signal'},payload=>{
    const msg=payload.payload
    if(!msg||msg.to!==profile.uuid) return
    if(msg.type==='offer') handleOffer(msg.from,msg.sdp)
    else if(msg.type==='answer') handleAnswer(msg.from,msg.sdp)
    else if(msg.type==='candidate') handleCandidate(msg.from,msg.candidate)
    else if(msg.type==='message') appendMessage(msg.data,false,msg.isImage)
    else if(msg.type==='typing') showTyping(msg.from)
  })

  await presence.subscribe(); await signaling.subscribe()
  broadcastPresence('join')
  setInterval(()=>broadcastPresence('update'),25000)
  window.addEventListener('beforeunload',()=>broadcastPresence('leave'))
}
async function broadcastPresence(action){await supabase.channel('public:presence').send({type:'broadcast',event:'user-presence',payload:{...profile,action,ts:Date.now()}})}

// WebRTC connections
function createPeerConnection(peer){
  const pc=new RTCPeerConnection()
  const dc=pc.createDataChannel('chat')
  dc.onmessage=e=>appendMessage(e.data,false)
  dataChannelMap[peer]=dc
  pc.onicecandidate=e=>{if(e.candidate) sendSignal(peer,{type:'candidate',candidate:e.candidate})}
  pc.ondatachannel=e=>{e.channel.onmessage=e=>appendMessage(e.data,false)}
  pcMap[peer]=pc
  makeOffer(peer)
}
async function makeOffer(peer){const pc=pcMap[peer]; const offer=await pc.createOffer(); await pc.setLocalDescription(offer); sendSignal(peer,{type:'offer',sdp:offer})}
async function handleOffer(from,sdp){if(!pcMap[from]){const pc=new RTCPeerConnection(); pc.ondatachannel=e=>{e.channel.onmessage=e=>appendMessage(from,false)}; pc.onicecandidate=e=>{if(e.candidate) sendSignal(from,{type:'candidate',candidate:e.candidate})}; pcMap[from]=pc} const pc=pcMap[from]; await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); sendSignal(from,{type:'answer',sdp:answer})}
async function handleAnswer(from,sdp){await pcMap[from]?.setRemoteDescription(new RTCSessionDescription(sdp))}
async function handleCandidate(from,candidate){await pcMap[from]?.addIceCandidate(new RTCIceCandidate(candidate))}
function sendSignal(to,msg){supabase.channel('public:signaling').send({type:'broadcast',event:'signal',payload:{...msg,from:profile.uuid,to}})}
function showTyping(user){if(currentPeer!==user) return; chatStatus.textContent='Typing...'; clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>chatStatus.textContent='Online',1000)}

startRealtime()
</script>

</body>
</html>
