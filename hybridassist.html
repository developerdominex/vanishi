<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hybrid Assit</title>
<link rel="icon" type="image/png" href="hybrid.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --accent:#6366f1;
  --accent-hover:#4f46e5;
  --bg:#f9fafb;
  --card:#ffffff;
  --muted:#6b7280;
  --text:#111827;
  --shadow:rgba(0,0,0,0.06);
  --bot:#f3f4f6;
  --user:#eef2ff;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,sans-serif;}
body{height:100vh;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

#titlebar {
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;
  background:var(--accent);
  color:#fff;
  font-weight:600;
  font-size:16px;
  position:fixed;top:0;left:0;width:100%;z-index:10;
  border-bottom:1px solid rgba(255,255,255,0.2);
}
#titlebar i{margin-right:8px;}

.wrap {
  display:flex;flex-direction:column;
  flex:1;
  padding-top:60px;   /* header height */
  padding-bottom:90px; /* input bar height */
  overflow:hidden;
}

#chat-area {
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  scroll-behavior:smooth;
}

.bubble{
  max-width:80%;
  padding:14px 16px;
  border-radius:16px;
  line-height:1.5;
  font-size:14px;
  word-break:break-word;
  white-space:pre-wrap;
  box-shadow:0 4px 12px var(--shadow);
  animation:fadeIn .2s ease-out;
}
.user{
  margin-left:auto;
  background:var(--user);
  color:var(--text);
  border-bottom-right-radius:4px;
}
.bot{
  margin-right:auto;
  background:var(--bot);
  color:var(--text);
  border-bottom-left-radius:4px;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(6px);}
  to{opacity:1;transform:none;}
}

.typing{display:inline-block;width:46px;height:14px;position:relative;}
.typing span{position:absolute;width:8px;height:8px;background:var(--accent);border-radius:50%;animation:blink 1s infinite;bottom:0;}
.typing span:nth-child(2){left:12px;animation-delay:.12s;}
.typing span:nth-child(3){left:24px;animation-delay:.24s;}
@keyframes blink{0%{transform:translateY(0);opacity:.25}50%{transform:translateY(-6px);opacity:1}100%{transform:translateY(0);opacity:.25}}

#inputbar {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  z-index:10;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:12px 16px;
  background:var(--card);
  border-top:1px solid #e5e7eb;
  box-shadow:0 -4px 12px var(--shadow);
}
.input-row{display:flex;width:100%;gap:8px;align-items:center;}
#txt{
  flex:1;
  border-radius:999px;
  padding:12px 16px;
  border:1px solid #e5e7eb;
  font-size:15px;
  outline:none;
  transition:all .2s ease;
}
#txt:focus{box-shadow:0 4px 12px var(--shadow);border-color:var(--accent);}
#send{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:12px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:15px;
  display:none;
}
#send:active{transform:translateY(1px);}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.chip{
  background:var(--bot);
  color:var(--accent);
  padding:6px 12px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  border:1px solid rgba(99,102,241,0.2);
  transition:all .2s ease;
}
.chip:hover{
  background:var(--accent);
  color:#fff;
  transform:translateY(-2px);
  box-shadow:0 6px 14px rgba(99,102,241,0.1);
}

.card{
  background:var(--card);
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:12px;
  margin-top:8px;
  box-shadow:0 2px 8px var(--shadow);
}
.card img{max-width:100%;border-radius:8px;margin-bottom:6px;}
.card a{color:var(--accent);text-decoration:none;font-weight:600;}

@media(max-width:520px){
  .bubble{max-width:92%;}
  #txt{font-size:14px;}
}

</style>
</head>
<body>

<div id="titlebar"><div><i class="fa-solid fa-robot"></i> Hybrid Assist</div></div>

<div class="wrap">
  <div id="chat-area" aria-live="polite"></div>

  <div id="inputbar">
    <div class="input-row">
      <input id="txt" placeholder="Ask me anything (knowledge, apps, images...)">
      <button id="send"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>
</div>
<script>
const chatArea=document.getElementById('chat-area');
const txt=document.getElementById('txt');
const send=document.getElementById('send');

function appendUser(text){
  const el=document.createElement('div');
  el.className='bubble user';
  el.textContent=text.trim();
  chatArea.appendChild(el);
  chatArea.scrollTop=chatArea.scrollHeight;
}

function appendBotBubble(){
  const el=document.createElement('div');
  el.className='bubble bot';
  chatArea.appendChild(el);
  chatArea.scrollTop=chatArea.scrollHeight;
  return el;
}

function appendTyping(){
  const el=document.createElement('div');
  el.className='bubble bot';
  el.id='typingBubble';
  el.innerHTML='<div style="display:flex;align-items:center;gap:10px;"><div class="typing"><span></span><span></span><span></span></div><div style="color:var(--muted);">Thinking...</div></div>';
  chatArea.appendChild(el);
  chatArea.scrollTop=chatArea.scrollHeight;
  return el;
}

function removeTyping(){const t=document.getElementById('typingBubble');if(t)t.remove();}

async function typeWriter(el,html,speed=5){
  return new Promise(resolve=>{
    let i=0;
    const words=html.split(/(\s+)/);
    el.innerHTML='';
    const cursor='<span style="border-right:2px solid #4f46e5;opacity:.6"></span>';
    const timer=setInterval(()=>{
      el.innerHTML=words.slice(0,i).join('')+cursor;
      chatArea.scrollTop=chatArea.scrollHeight;
      i++;
      if(i>words.length){
        clearInterval(timer);
        el.innerHTML=html;
        resolve();
      }
    },speed);
  });
}

function escapeHtml(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function escapeAttr(s){return(s||'').replace(/"/g,'&quot;');}

function normalizeForSearch(q){
  q=q.trim();
  const patterns=[/^who (is|was)\s+/i,/^what (is|are|was)\s+/i,/^tell me about\s+/i,/^define\s+/i,/^explain\s+/i];
  for(const p of patterns) q=q.replace(p,'');
  return q.replace(/^[^\w]+|[^\w]+$/g,'').trim()||q;
}

/* --- Natural Language Rewriter --- */
function smoothText(text){
  if(!text) return "";
  text=text.replace(/\s+/g,' ').trim();

  // Capitalize first letter of sentences
  text=text.replace(/([.!?]\s+)([a-z])/g,(m,p1,p2)=>p1+p2.toUpperCase());
  if(text.length>1) text=text[0].toUpperCase()+text.slice(1);

  // Make tone slightly conversational
  text=text.replace(/\b(are|were|was|is)\b/g,match=>{
    const map={'is':'is often seen as','was':'was known as','are':'are generally considered','were':'were known as'};
    return map[match]||match;
  });

  // Smooth transitions and readability
  text=text.replace(/\bfor example\b/gi,'for instance');
  text=text.replace(/\be\.g\.\b/gi,'for instance');
  text=text.replace(/\betc\.\b/gi,'and so on');
  text=text.replace(/\bhowever\b/gi,'but');
  text=text.replace(/\btherefore\b/gi,'as a result');
  text=text.replace(/\bthus\b/gi,'as a result');
  text=text.replace(/\bthis was\b/gi,'This was');
  return text;
}

async function fetchWikiSmart(raw){
  const query=normalizeForSearch(raw);
  const url=`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&srlimit=5&utf8=&format=json&origin=*`;
  const res=await fetch(url);
  const j=await res.json();
  const results=j.query?.search||[];
  if(!results.length) return {type:'no-result'};
  const top=results[0];
  const title=top.title;
  const sumUrl=`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  const sum=await fetch(sumUrl).then(r=>r.json());
  let extract=sum.extract||'';
  let imageUrl=sum.thumbnail?.source||null;
  if(extract.length>1000) extract=extract.split(/(?<=[.!?])\s+/).slice(0,5).join(' ');
  extract=smoothText(extract);
  return {type:'summary',title,summary:extract,imageUrl};
}

async function showLongSummary(title){
  appendUser(`Show more about ${title}`);
  const typing=appendTyping();
  try{
    const url=`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&explaintext=1&format=json&titles=${encodeURIComponent(title)}&origin=*`;
    const r=await fetch(url); const j=await r.json();
    const pages=j.query?.pages?Object.values(j.query.pages):[];const page=pages[0]||{};
    let ext=page.extract||'No extra details.';
    removeTyping();
    const parts=ext.split(/(?<=[.!?])\s+/).filter(Boolean).slice(0,8).map(s=>smoothText(s.trim()));
    const bubble=appendBotBubble();
    await typeWriter(bubble,`<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(title)} â€” details</div><div style="white-space:pre-wrap;">${escapeHtml(parts.join('\n\n'))}</div>`);
  } catch(e){ removeTyping(); appendBotBubble().innerHTML="Couldn't load details";}
}

async function showSection(title,sectionName){
  appendUser(`${sectionName} of ${title}`);
  const typing=appendTyping();
  try{
    const url=`https://en.wikipedia.org/api/rest_v1/page/mobile-sections/${encodeURIComponent(title)}`;
    const r=await fetch(url); const j=await r.json();
    removeTyping();
    const allSecs=[...(j.lead?.sections||[]),...(j.remaining?.sections||[])];
    const sec=allSecs.find(s=>(s.line||'').toLowerCase().includes(sectionName.toLowerCase()));
    if(!sec){ appendBotBubble().innerHTML=`No section "${escapeHtml(sectionName)}"`; return;}
    let text=sec.text||"";
    text=text.replace(/<\/?[^>]+(>|$)/g,'');
    text=smoothText(text);
    const snippet=text.split(/(?<=[.!?])\s+/).slice(0,10).join('\n\n');
    const bubble=appendBotBubble();
    await typeWriter(bubble,`<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(title)} â€” ${escapeHtml(sec.line)}</div><div style="white-space:pre-wrap;">${escapeHtml(snippet)}</div>`);
  }catch(e){ removeTyping(); appendBotBubble().innerHTML="Couldn't fetch section";}
}

async function showRelated(title){
  appendUser(`Related to ${title}`);
  const t=appendTyping();
  try{
    const url=`https://en.wikipedia.org/w/api.php?action=query&prop=links&titles=${encodeURIComponent(title)}&pllimit=20&format=json&origin=*`;
    const r=await fetch(url); const j=await r.json();
    removeTyping();
    const pages=j.query?.pages?Object.values(j.query.pages):[];
    const links=pages[0]?.links?.map(l=>l.title).slice(0,5)||[];
    if(!links.length){appendBotBubble().innerHTML="No related topics found"; return;}
    const chips=links.map(l=>`<div class="chip" data-type="direct" data-q="${escapeAttr(l)}">${escapeHtml(l)}</div>`).join('');
    const bubble=appendBotBubble();
    bubble.innerHTML=`<div style="font-weight:600;margin-bottom:6px;">Related topics</div><div class="chips">${chips}</div>`;
    bubble.querySelectorAll('.chip').forEach(chip=>chip.addEventListener('click',()=>{txt.value=chip.getAttribute('data-q');handleQuery(txt.value);}));
  }catch(e){ removeTyping(); appendBotBubble().innerHTML="Couldn't load related";}
}

async function fetchWikiImages(query){
  const url=`https://en.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(query)}&gsrlimit=20&prop=pageimages&format=json&origin=*&piprop=thumbnail&pithumbsize=500`;
  const r=await fetch(url); const j=await r.json();
  const pages=j.query?.pages?Object.values(j.query.pages):[];
  return pages.filter(p=>p.thumbnail).map(p=>({title:p.title,src:p.thumbnail.source}));
}

function buildImageGrid(images){
  return `
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;">
      ${images.map(img=>`
        <div class="image-choice" data-src="${escapeAttr(img.src)}" data-title="${escapeAttr(img.title)}" 
             style="cursor:pointer;border:1px solid #ddd;border-radius:8px;overflow:hidden;">
          <img src="${img.src}" style="width:100%;height:140px;object-fit:cover;">
          <div style="padding:6px;font-size:13px;text-align:center;color:#374151;">${escapeHtml(img.title)}</div>
        </div>
      `).join('')}
    </div>
    <div style="margin-top:8px;color:var(--muted);font-size:13px;">Click an image to view</div>
  `;
}

function attachImageHandlers(bubble){
  bubble.querySelectorAll('.image-choice').forEach(choice=>{
    choice.addEventListener('click',()=>{
      const src=choice.getAttribute('data-src');
      const title=choice.getAttribute('data-title');
      const overlay=document.createElement('div');
      overlay.style.position="fixed";
      overlay.style.top=0;overlay.style.left=0;overlay.style.right=0;overlay.style.bottom=0;
      overlay.style.background="rgba(0,0,0,0.8)";
      overlay.style.display="flex";overlay.style.justifyContent="center";overlay.style.alignItems="center";
      overlay.style.zIndex="9999";
      overlay.innerHTML=`
        <div style="position:relative;max-width:90%;max-height:90%;">
          <img src="${src}" alt="${title}" style="max-width:100%;max-height:100%;border-radius:8px;">
          <span style="position:absolute;top:-12px;right:-12px;background:#fff;border-radius:50%;padding:6px 10px;cursor:pointer;font-weight:bold;">âœ–</span>
        </div>`;
      overlay.querySelector("span").onclick=()=>overlay.remove();
      document.body.appendChild(overlay);
    });
  });
}

async function handleQuery(raw){
  if(!raw?.trim()) return;
  appendUser(raw); appendTyping();
  try{
    let bubble;
    if(/image|photo|picture/i.test(raw)){
      const imgs=await fetchWikiImages(raw); removeTyping(); bubble=appendBotBubble();
      if(imgs.length){ await typeWriter(bubble,buildImageGrid(imgs)); attachImageHandlers(bubble);}
      else bubble.innerHTML="No images found";
    }
    else {
      const result=await fetchWikiSmart(raw); removeTyping(); bubble=appendBotBubble();
      if(result.type==='no-result'){ bubble.innerHTML="Sorry, I couldn't find anything about that."; return;}
      let card=`<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(result.title)}</div>`;
      if(result.imageUrl) card+=`<img src="${result.imageUrl}" style="max-width:100%;border-radius:8px;margin-bottom:6px;">`;
      card+=`<div style="white-space:pre-wrap;color:#374151;">${escapeHtml(result.summary)}</div>`;
      await typeWriter(bubble,card);
      bubble.innerHTML+=`<div class="chips" style="margin-top:8px;">
        <div class="chip" data-type="more" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-circle-info"></i> More details</div>
        <div class="chip" data-type="timeline" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-clock"></i> Timeline / History</div>
        <div class="chip" data-type="related" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-link"></i> Related topics</div>
      </div>`;
      bubble.querySelectorAll('.chip').forEach(chip=>{
        chip.addEventListener('click',async()=>{
          const type=chip.getAttribute('data-type'); const q=chip.getAttribute('data-q');
          if(type==='more') await showLongSummary(q);
          if(type==='timeline') await showSection(q,'Timeline');
          if(type==='related') await showRelated(q);
        });
      });
    }
  }catch(e){ removeTyping(); appendBotBubble().innerHTML="Error fetching information."; console.error(e);}
}

async function onSend(){ const v=txt.value.trim(); if(!v) return; txt.value=''; send.style.display="none"; await handleQuery(v);}
send.addEventListener('click',onSend);
txt.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); onSend();}});
txt.addEventListener('input',()=>{ send.style.display=txt.value.trim()? "inline-block":"none"; });

function clearChat(){ chatArea.innerHTML=''; }
window.addEventListener('beforeunload',clearChat);

/* --- Greeting --- */
(function greet(){
  const welcome=`<div style="font-weight:700;margin-bottom:6px;">Hi â€” I'm Hybrid Assistant ðŸ¤–</div>
  <div style="color:var(--muted)">Ask me about history, science, world events, or images. I summarize and explain naturally using open data sources.</div>
  <div style="color:#dc2626;margin-top:6px;font-weight:600;">Note: I donâ€™t show videos or private content. You can use the desktop Hybrid Browser for that â€” visit https://downloadhybrid.pages.dev/ </div>
  <div class="chips" style="margin-top:10px;">
    <div class="chip" data-q="Alexander The Great">Who was Alexander The Great?</div>
    <div class="chip" data-q="Industrial Revolution">Tell me about the Industrial Revolution</div>
    <div class="chip" data-q="Black hole images">Show black hole images</div>
  </div>`;
  const b=appendBotBubble();
  typeWriter(b,welcome,20).then(()=>{
    b.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>{txt.value=c.getAttribute('data-q'); onSend();}));
  });
})();
</script>


</body>
</html>
