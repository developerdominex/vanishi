<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0";

// === GLOBALS ===
let rephraser = null;
let modelReady = false;

// === DOM ELEMENTS ===
const chatArea = document.getElementById('chat-area');
const txt = document.getElementById('txt');
const send = document.getElementById('send');

// === NON-BLOCKING MODEL LOADER ===
(async function loadTinyModel() {
  try {
    showModelStatus('Loading tiny rephraser model (background)...', 3000);
    // Use very lightweight model for smoothing
    const modelPromise = pipeline("text2text-generation", "t5-efficient-tiny");
    const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('load timeout')), 25000));
    rephraser = await Promise.race([modelPromise, timeout]);
    modelReady = true;
    console.log("Tiny rephraser ready.");
    showModelStatus('Rephraser ready â€” smoothing active', 4000);
  } catch (e) {
    console.warn("Rephraser failed:", e);
    showModelStatus('Rephraser unavailable â€” showing original text', 4000);
  }
})();

// === UI HELPERS ===
function appendUser(text) {
  const el = document.createElement('div');
  el.className = 'bubble user';
  el.textContent = text;
  chatArea.appendChild(el);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function appendBotBubble() {
  const el = document.createElement('div');
  el.className = 'bubble bot';
  chatArea.appendChild(el);
  chatArea.scrollTop = chatArea.scrollHeight;
  return el;
}

function appendTyping() {
  const el = document.createElement('div');
  el.className = 'bubble bot';
  el.id = 'typingBubble';
  el.innerHTML = '<div style="display:flex;align-items:center;gap:10px;"><div class="typing"><span></span><span></span><span></span></div><div style="color:var(--muted);">Thinking...</div></div>';
  chatArea.appendChild(el);
  chatArea.scrollTop = chatArea.scrollHeight;
  return el;
}
function removeTyping() {
  const t = document.getElementById('typingBubble');
  if (t) t.remove();
}

async function typeWriter(el, html, speed = 5) {
  return new Promise(resolve => {
    let i = 0;
    const words = html.split(/(\s+)/);
    el.innerHTML = '';
    const cursor = '<span style="border-right:2px solid #4f46e5;opacity:.6"></span>';
    const timer = setInterval(() => {
      el.innerHTML = words.slice(0, i).join('') + cursor;
      chatArea.scrollTop = chatArea.scrollHeight;
      i++;
      if (i > words.length) {
        clearInterval(timer);
        el.innerHTML = html;
        resolve();
      }
    }, speed);
  });
}

function showModelStatus(msg, timeout = 3000) {
  const el = document.createElement('div');
  el.className = 'bubble bot';
  el.style.opacity = 0.9;
  el.style.fontSize = '13px';
  el.style.background = '#fff6e5';
  el.style.color = '#92400e';
  el.style.border = '1px solid #feebc8';
  el.style.maxWidth = '60%';
  el.textContent = msg;
  chatArea.appendChild(el);
  chatArea.scrollTop = chatArea.scrollHeight;
  if (timeout) setTimeout(() => el.remove(), timeout);
}

function escapeHtml(s) {
  return (s || '').replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}
function escapeAttr(s) {
  return (s || '').replace(/"/g, '&quot;');
}

function normalizeForSearch(q) {
  q = q.trim();
  const patterns = [/^who (is|was)\s+/i, /^what (is|are|was)\s+/i, /^tell me about\s+/i, /^define\s+/i, /^explain\s+/i];
  for (const p of patterns) q = q.replace(p, '');
  return q.replace(/^[^\w]+|[^\w]+$/g, '').trim() || q;
}

// === TEXT REPHRASER ===
async function rephraseText(text) {
  if (!modelReady || !rephraser) return text;
  try {
    const prompt = "Paraphrase this text clearly and naturally: " + text;
    const out = await rephraser(prompt, { max_length: 200 });
    return out[0].generated_text || text;
  } catch (e) {
    console.warn("Rephrase error:", e);
    return text;
  }
}

// === FETCH WIKIPEDIA SUMMARY ===
async function fetchWikiSmart(raw) {
  const query = normalizeForSearch(raw);
  const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&srlimit=5&utf8=&format=json&origin=*`;
  const res = await fetch(url);
  const j = await res.json();
  const results = j.query?.search || [];
  if (!results.length) return { type: 'no-result' };
  const top = results[0];
  const title = top.title;
  const sumUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  const sum = await fetch(sumUrl).then(r => r.json());
  let extract = sum.extract || '';
  let imageUrl = sum.thumbnail?.source || null;
  if (extract.length > 1000) extract = extract.split(/(?<=[.!?])\s+/).slice(0, 5).join(' ');
  const smooth = await rephraseText(extract);
  return { type: 'summary', title, summary: smooth, imageUrl };
}

// === SUBSECTIONS, DETAILS, RELATED ===
async function showLongSummary(title) {
  appendUser(`Show more about ${title}`);
  const typing = appendTyping();
  try {
    const url = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&explaintext=1&format=json&titles=${encodeURIComponent(title)}&origin=*`;
    const r = await fetch(url);
    const j = await r.json();
    const pages = j.query?.pages ? Object.values(j.query.pages) : [];
    const page = pages[0] || {};
    const ext = page.extract || 'No extra details.';
    removeTyping();
    const smooth = await rephraseText(ext);
    const parts = smooth.split(/(?<=[.!?])\s+/).filter(Boolean).slice(0, 8).map(s => escapeHtml(s.trim()));
    const bubble = appendBotBubble();
    await typeWriter(bubble, `<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(title)} â€” details</div><div style="white-space:pre-wrap;">${parts.join('\n\n')}</div>`);
  } catch (e) {
    removeTyping();
    appendBotBubble().innerHTML = "Couldn't load details";
  }
}

async function showSection(title, sectionName) {
  appendUser(`${sectionName} of ${title}`);
  const typing = appendTyping();
  try {
    const url = `https://en.wikipedia.org/api/rest_v1/page/mobile-sections/${encodeURIComponent(title)}`;
    const r = await fetch(url);
    const j = await r.json();
    removeTyping();
    const allSecs = [...(j.lead?.sections || []), ...(j.remaining?.sections || [])];
    const sec = allSecs.find(s => (s.line || '').toLowerCase().includes(sectionName.toLowerCase()));
    if (!sec) {
      appendBotBubble().innerHTML = `No section "${escapeHtml(sectionName)}"`;
      return;
    }
    let text = sec.text || "";
    text = text.replace(/<\/?[^>]+(>|$)/g, '');
    const smooth = await rephraseText(text);
    const snippet = smooth.split(/(?<=[.!?])\s+/).slice(0, 10).join('\n\n');
    const bubble = appendBotBubble();
    await typeWriter(bubble, `<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(title)} â€” ${escapeHtml(sec.line)}</div><div style="white-space:pre-wrap;">${escapeHtml(snippet)}</div>`);
  } catch (e) {
    removeTyping();
    appendBotBubble().innerHTML = "Couldn't fetch section";
  }
}

async function showRelated(title) {
  appendUser(`Related to ${title}`);
  const t = appendTyping();
  try {
    const url = `https://en.wikipedia.org/w/api.php?action=query&prop=links&titles=${encodeURIComponent(title)}&pllimit=20&format=json&origin=*`;
    const r = await fetch(url);
    const j = await r.json();
    removeTyping();
    const pages = j.query?.pages ? Object.values(j.query.pages) : [];
    const links = pages[0]?.links?.map(l => l.title).slice(0, 5) || [];
    if (!links.length) {
      appendBotBubble().innerHTML = "No related topics found";
      return;
    }
    const chips = links.map(l => `<div class="chip" data-type="direct" data-q="${escapeAttr(l)}">${escapeHtml(l)}</div>`).join('');
    const bubble = appendBotBubble();
    bubble.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">Related topics</div><div class="chips">${chips}</div>`;
    bubble.querySelectorAll('.chip').forEach(chip => chip.addEventListener('click', () => {
      txt.value = chip.getAttribute('data-q');
      handleQuery(txt.value);
    }));
  } catch (e) {
    removeTyping();
    appendBotBubble().innerHTML = "Couldn't load related";
  }
}

// === MAIN QUERY HANDLER ===
async function handleQuery(raw) {
  if (!raw?.trim()) return;
  appendUser(raw);
  appendTyping();
  try {
    const result = await fetchWikiSmart(raw);
    removeTyping();
    const bubble = appendBotBubble();
    if (result.type === 'no-result') {
      bubble.innerHTML = "No results found";
      return;
    }
    let card = `<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(result.title)}</div>`;
    if (result.imageUrl) card += `<img src="${result.imageUrl}" style="max-width:100%;border-radius:8px;margin-bottom:6px;">`;
    card += `<div style="white-space:pre-wrap;color:#374151;">${escapeHtml(result.summary)}</div>`;
    await typeWriter(bubble, card);
    bubble.innerHTML += `<div class="chips" style="margin-top:8px;">
      <div class="chip" data-type="more" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-circle-info"></i> More details</div>
      <div class="chip" data-type="timeline" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-clock"></i> Timeline / History</div>
      <div class="chip" data-type="related" data-q="${escapeAttr(result.title)}"><i class="fa-solid fa-link"></i> Related topics</div>
    </div>`;
    bubble.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', async () => {
        const type = chip.getAttribute('data-type');
        const q = chip.getAttribute('data-q');
        if (type === 'more') await showLongSummary(q);
        if (type === 'timeline') await showSection(q, 'Timeline');
        if (type === 'related') await showRelated(q);
      });
    });
  } catch (e) {
    removeTyping();
    appendBotBubble().innerHTML = "Error fetching info";
    console.error(e);
  }
}

// === INPUT HANDLERS ===
async function onSend() {
  const v = txt.value.trim();
  if (!v) return;
  txt.value = '';
  send.style.display = "none";
  await handleQuery(v);
}
send.addEventListener('click', onSend);
txt.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    onSend();
  }
});
txt.addEventListener('input', () => {
  send.style.display = txt.value.trim() ? "inline-block" : "none";
});

// === GREETING ===
(function greet() {
  const welcome = `<div style="font-weight:700;margin-bottom:6px;">Hi â€” I'm Hybrid ðŸ¤–</div>
  <div style="color:var(--muted)">Ask me about history, wars, politics, science, and more.</div>
  <div class="chips" style="margin-top:10px;">
    <div class="chip" data-q="Industrial Revolution"><i class="fa-solid fa-industry"></i> Industrial Revolution</div>
    <div class="chip" data-q="Cold War"><i class="fa-solid fa-flag"></i> Cold War</div>
    <div class="chip" data-q="World War II"><i class="fa-solid fa-earth-europe"></i> World War II</div>
  </div>`;
  const b = appendBotBubble();
  typeWriter(b, welcome, 20).then(() => {
    b.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => {
      txt.value = c.getAttribute('data-q');
      onSend();
    }));
  });
})();
</script>
