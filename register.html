<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register â€” Hybrid Chat</title>
<link rel="icon" type="image/png" href="hybrid.png">
<link rel="stylesheet" href="register.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <h2>Welcome to Starlight</h2>
  <p>Sign in with Google to continue</p>

  <div id="buttonDiv"></div>

  <div id="profilePreview" class="hidden">
    <h3>Profile Preview</h3>
    <img id="userAvatar" alt="Avatar">
    <p><strong>Name:</strong> <span id="userName"></span></p>
    <p><strong>Email:</strong> <span id="userEmail"></span></p>
    <button id="continueBtn">Continue</button>
  </div>

  <div id="messageBox" class="hidden"></div>
</div>

<script>
  const SUPABASE_URL = "https://dfzshvldanqfvfivjrqi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmenNodmxkYW5xZnZmaXZqcnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIxNTEsImV4cCI6MjA3MDM3ODE1MX0.wdms-6G9eDzRuk1YiCpdyvVS-5CRKCsrq9WWWIFl9HA";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const profilePreview = document.getElementById("profilePreview");
const userAvatar = document.getElementById("userAvatar");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");
const continueBtn = document.getElementById("continueBtn");
const messageBox = document.getElementById("messageBox");

const storedProfile = localStorage.getItem("hc_profile");
if (storedProfile) {
  window.location.href = "/";
}

window.onload = () => {
  google.accounts.id.initialize({
    client_id: "549003131640-o9umsg7tu0uisopde76mlf3lg5krt5g7.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(document.getElementById("buttonDiv"), {
    theme: "outline",
    size: "large",
    text: "signin_with",
    shape: "pill"
  });
};

function handleCredentialResponse(response) {
  try {
    const data = JSON.parse(atob(response.credential.split('.')[1]));
    userAvatar.src = data.picture;
    userName.textContent = data.name;
    userEmail.textContent = data.email;

    profilePreview.classList.remove("hidden");

    window.currentProfile = {
      id: data.sub,
      name: data.name,
      email: data.email,
      profile_url: data.picture
    };
  } catch (err) {
    showMessage("Failed to parse Google profile.");
  }
}

continueBtn.onclick = async () => {
  const profile = window.currentProfile;
  if (!profile) return showMessage("No profile data loaded.");

  try {
    const { data: existingUsers, error: selectError } = await supabase
      .from("users")
      .select("*")
      .or(`id.eq.${profile.id},email.eq.${profile.email}`)
      .single();

    if (selectError && selectError.code !== 'PGRST116') throw selectError; 

    if (existingUsers) {
      localStorage.setItem("hc_profile", JSON.stringify(existingUsers));
    } else {
      const { data, error } = await supabase
        .from("users")
        .insert([{
          id: profile.id,
          name: profile.name,
          email: profile.email,
          profile_url: profile.profile_url
        }])
        .select()
        .single();

      if (error) throw error;

      localStorage.setItem("hc_profile", JSON.stringify(data));
    }

    window.location.href = "/";
  } catch (err) {
    showMessage(err.message || "Failed to save user.");
  }
};

function showMessage(msg) {
  messageBox.textContent = msg;
  messageBox.classList.remove("hidden");
}
</script>
</body>
</html>

